# 三遍审校流程实现文档

## 概述

将原有的三个独立审校阶段（内容审校、风格审校、细节打磨）合并为一个统一的"内容审校"节点，采用左右分栏布局，左侧显示文章内容（带修改高亮），右侧显示三步审校流程，用户需按顺序完成三遍审校。

## 核心改进

### 1. 进度条简化

**原有设计：**
- 9 个节点：开始 → 明确需求 → 资料查询 → 段落摘要 → 文章生成 → 内容审校 → 风格审校 → 细节打磨 → 完成

**新设计：**
- 7 个节点：开始 → 明确需求 → 资料查询 → 段落摘要 → 文章生成 → 内容审校 → 完成
- 三遍审校合并为一个节点"内容审校"

**进度百分比调整：**
```typescript
const stages = [
  { key: 'init', label: '开始', progress: 0 },
  { key: 'confirm_brief', label: '明确需求', progress: 14 },
  { key: 'knowledge_selected', label: '资料查询', progress: 28 },
  { key: 'outline_confirmed', label: '段落摘要', progress: 42 },
  { key: 'drafting', label: '文章生成', progress: 56 },
  { key: 'review_pass_1', label: '内容审校', progress: 70 },
  { key: 'completed', label: '完成', progress: 100 },
];
```

### 2. 左右分栏布局

**左侧面板：文章内容**
- 显示当前文章内容
- 使用 diff 算法高亮显示修改
- 绿色背景：新增内容
- 红色背景 + 删除线：删除内容
- 最大高度 600px，支持滚动

**右侧面板：审校步骤**
- 三个审校卡片，按顺序排列
- 每个卡片包含：
  - 状态图标（Circle / CheckCircle2）
  - 标题和描述
  - 开始审校按钮
  - 完成状态标记
- 必须按顺序完成（第一遍 → 第二遍 → 第三遍）
- 最后显示"确认完成"按钮

### 3. Diff 高亮显示

使用 `diff` 库实现文本差异对比：

```typescript
import { diffWords } from 'diff';

const renderDiff = () => {
  const diff = diffWords(originalContent, currentContent);
  
  return (
    <div className="whitespace-pre-wrap text-sm leading-relaxed">
      {diff.map((part, index) => {
        if (part.added) {
          return (
            <span key={index} className="bg-green-200 dark:bg-green-900/50">
              {part.value}
            </span>
          );
        }
        if (part.removed) {
          return (
            <span key={index} className="bg-red-200 dark:bg-red-900/50 line-through">
              {part.value}
            </span>
          );
        }
        return <span key={index}>{part.value}</span>;
      })}
    </div>
  );
};
```

**特点：**
- 词级别的差异对比（diffWords）
- 保留原文格式（whitespace-pre-wrap）
- 支持深色模式
- 清晰的视觉反馈

## 三个 LLM Prompt

### Prompt 1: 内容审校（Content Review）

**角色：** 世界顶级学术编辑（Nature / Science 期刊）

**核心任务：** 深度润色，增强解释性、逻辑性和系统性

**协议 A：中文文本**
1. **增强解释性与逻辑链条**
   - 动词短语扩展："处理" → "对…进行处理"
   - 逻辑辅助词增强：添加"的"、"地"、"所"、"会"等

2. **实施系统性语言范式**
   - 系统性词汇替换："通过" → "借助"
   - 系统性句式优化："若…，则…" → "如果…，那么…"

3. **无缝整合括号内容**
   - 自然融入："ORM（对象关系映射）" → "对象关系映射（ORM）技术"

**协议 B：英文文本**
1. 初步转译：英文 → 中文
2. 结构性优化：应用协议 A 规则
3. 机械式回译：中文 → 英文（保留中文结构）
4. 最终输出：带有中文逻辑印记的英文

**绝对通用规则：**
- 技术内容保护：不修改术语、代码、API 路径
- 核心逻辑不变
- 禁止第一人称与不当口语
- 字数控制：与原文保持一致（±30字）
- 结构保持：维持段落划分
- 纯文本输出：无解释、注释

### Prompt 2: 风格审校（Style Review）

**角色：** 风格拟态专家（Style Mimicry Expert）

**核心任务：** 降低 AI 检测率，使文本更具人类写作风格

**策略 A：中文文本**
1. **增加冗余与解释性**
   - 动词短语扩展："管理" → "开展...的管理工作"
   - 增加辅助词/结构：添加"了"、"的"、"地"等

2. **系统性词汇替换**
   - 生僻词常用化："囊括" → "包括"
   - 特定动词/介词/连词替换："采用" → "运用"
   - 特定名词/形容词替换："特点" → "特性"

3. **括号内容处理**
   - 优先整合：使用"也就是"、"即"、"比如"等引导词
   - 谨慎省略：非核心信息可省略

4. **句式微调与自然化**
   - 使用"把"字句
   - 条件句式转换："若…，则…" → "要是...，那就..."
   - 增加连接词："那么"、"这样一来"、"同时"

**策略 B：英文文本**
1. 初步转译：英文 → 中文
2. 中文结构性优化：应用策略 A（聚焦结构，禁用修辞）
3. 机械式回译：中文 → 英文（结构绝对优先，词汇基础化）
4. 最终输出：带有异质感的英文

**最重要的要求：**
1. 不要有太多的连词和逻辑词，用最简单的单词
2. 英文先翻译为中文，用策略 A 处理，再逐字翻译回英文

### Prompt 3: 细节打磨（Detail Polishing）

**角色：** 资深学术期刊审稿人 + 学术写作编辑

**核心任务：** 语言与结构层面的精修，符合学术论文发表标准

**一、句子层面（Sentence-level）**
- 检查句子长度：20–35 字为主，不超过 45 字
- 提升句法学术性：避免口语化，优先使用"因此 / 从而 / 进而"
- 主谓关系清晰：避免主语缺失或指代不明

**二、段落层面（Paragraph-level）**
- 控制段落长度：每段 3–6 句
- 段落结构规范：首句提出观点，中间解释论证，末句总结过渡
- 避免段落功能混杂：不在同一段中同时出现背景 + 方法 + 结论

**三、标点与节奏（Academic Rhythm）**
- 标点使用：以句号为主，减少多个逗号串联
- 阅读节奏：长句与短句交替

**四、显式检查任务**
- 列出所有超过 45 字的句子
- 给出拆分后的推荐版本

**五、输出要求**
- 输出润色后的完整文本
- 不要解释修改原则
- 保持学术、客观、中性语气

## 技术实现

### 组件状态管理

```typescript
const [draft, setDraft] = useState<Draft | null>(null);
const [currentContent, setCurrentContent] = useState('');
const [originalContent, setOriginalContent] = useState('');
const [completedSteps, setCompletedSteps] = useState<ReviewStep[]>([]);
const [processingStep, setProcessingStep] = useState<ReviewStep | null>(null);
const [confirming, setConfirming] = useState(false);
```

**状态说明：**
- `draft`: 当前草稿对象
- `currentContent`: 当前显示的文章内容（会随审校更新）
- `originalContent`: 原始文章内容（用于 diff 对比）
- `completedSteps`: 已完成的审校步骤数组
- `processingStep`: 当前正在处理的步骤
- `confirming`: 是否正在确认完成

### 审校流程

```typescript
const handleReview = async (step: ReviewStep) => {
  if (!currentContent) {
    toast({ title: '无内容', description: '请先生成文章内容', variant: 'destructive' });
    return;
  }

  setProcessingStep(step);
  try {
    let systemMessage = '';
    
    if (step === 'content') {
      systemMessage = CONTENT_REVIEW_PROMPT;
    } else if (step === 'style') {
      systemMessage = STYLE_REVIEW_PROMPT;
    } else if (step === 'detail') {
      systemMessage = DETAIL_REVIEW_PROMPT;
    }

    const result = await callLLMGenerate(currentContent, '', systemMessage);
    
    setCurrentContent(result);
    setCompletedSteps([...completedSteps, step]);
    
    // 保存到草稿
    if (draft) {
      await updateDraft(draft.id, { content: result });
    }
    
    toast({ title: '审校完成', description: getStepName(step) + ' 已完成' });
  } catch (error: any) {
    toast({ title: '审校失败', description: error.message || '无法完成审校', variant: 'destructive' });
  } finally {
    setProcessingStep(null);
  }
};
```

**流程说明：**
1. 检查是否有内容
2. 设置当前处理步骤
3. 根据步骤选择对应的 Prompt
4. 调用 LLM 生成审校结果
5. 更新当前内容
6. 标记步骤为已完成
7. 保存到草稿
8. 显示成功提示

### 按钮禁用逻辑

```typescript
// 第一遍：内容审校
disabled={processingStep !== null || completedSteps.includes('content')}

// 第二遍：风格审校
disabled={processingStep !== null || !completedSteps.includes('content') || completedSteps.includes('style')}

// 第三遍：细节打磨
disabled={processingStep !== null || !completedSteps.includes('style') || completedSteps.includes('detail')}

// 确认完成
disabled={confirming || completedSteps.length < 3}
```

**禁用条件：**
- 有步骤正在处理时，所有按钮禁用
- 第二遍必须在第一遍完成后才能开始
- 第三遍必须在第二遍完成后才能开始
- 确认完成必须在三遍全部完成后才能点击

### 确认完成

```typescript
const handleConfirm = async () => {
  if (completedSteps.length < 3) {
    toast({ title: '请完成所有审校步骤', variant: 'destructive' });
    return;
  }

  setConfirming(true);
  try {
    await updateProject(projectId, { status: 'completed' });
    toast({ title: '审校完成', description: '文章已完成所有审校' });
    onComplete();
  } catch (error) {
    toast({ title: '确认失败', variant: 'destructive' });
  } finally {
    setConfirming(false);
  }
};
```

## UI 设计

### 布局结构

```
┌─────────────────────────────────────────────────────────────┐
│ 内容审校                                                      │
│ 三遍审校流程：内容审校 → 风格审校 → 细节打磨                   │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────────┬──────────────────────────────────┐
│ 文章内容                  │ 审校步骤                          │
│ 已完成 X/3 遍审校         │ 请按顺序完成三遍审校               │
├──────────────────────────┼──────────────────────────────────┤
│                          │ ┌──────────────────────────────┐ │
│                          │ │ ✓ 第一遍：内容审校            │ │
│                          │ │ 检查事实准确性、逻辑清晰性     │ │
│  [Diff 高亮显示的文章]    │ │ [已完成]                     │ │
│                          │ └──────────────────────────────┘ │
│                          │                                  │
│                          │ ┌──────────────────────────────┐ │
│                          │ │ ○ 第二遍：风格审校            │ │
│                          │ │ 降低 AI 味，删除套话          │ │
│                          │ │ [开始审校]                    │ │
│                          │ └──────────────────────────────┘ │
│                          │                                  │
│                          │ ┌──────────────────────────────┐ │
│                          │ │ ○ 第三遍：细节打磨            │ │
│                          │ │ 检查句子长度、段落长度         │ │
│                          │ │ [开始审校]                    │ │
│                          │ └──────────────────────────────┘ │
│                          │                                  │
│                          │ [确认完成]                        │
└──────────────────────────┴──────────────────────────────────┘
```

### 视觉元素

**状态图标：**
- 未完成：`<Circle className="h-5 w-5 text-muted-foreground" />`
- 已完成：`<CheckCircle2 className="h-5 w-5 text-green-500" />`

**状态标记：**
- 已完成：`<Badge variant="default">已完成</Badge>`

**卡片边框：**
- 已完成：`className={completedSteps.includes('content') ? 'border-green-500' : ''}`

**加载状态：**
- 处理中：`<Loader2 className="h-4 w-4 mr-2 animate-spin" />`

### 响应式设计

```typescript
<div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
  {/* 左侧：文章内容 */}
  <Card className="lg:col-span-1">...</Card>
  
  {/* 右侧：审校步骤 */}
  <Card className="lg:col-span-1">...</Card>
</div>
```

**断点说明：**
- 小屏幕（< lg）：上下堆叠
- 大屏幕（≥ lg）：左右分栏

## 用户操作流程

### 1. 进入审校阶段

- 用户完成文章生成后，项目状态变为 `review_pass_1`
- 系统自动加载最新草稿内容
- 左侧显示原始文章内容
- 右侧显示三个审校步骤

### 2. 第一遍：内容审校

- 用户点击"开始审校"按钮
- 系统调用 LLM，使用内容审校 Prompt
- 左侧实时更新为审校后的内容，并高亮显示修改
- 第一遍标记为已完成，显示绿色勾选图标
- 第二遍按钮变为可用状态

### 3. 第二遍：风格审校

- 用户点击"开始审校"按钮
- 系统调用 LLM，使用风格审校 Prompt
- 左侧更新为风格审校后的内容，继续高亮显示修改
- 第二遍标记为已完成
- 第三遍按钮变为可用状态

### 4. 第三遍：细节打磨

- 用户点击"开始审校"按钮
- 系统调用 LLM，使用细节打磨 Prompt
- 左侧更新为细节打磨后的内容，继续高亮显示修改
- 第三遍标记为已完成
- "确认完成"按钮变为可用状态

### 5. 确认完成

- 用户点击"确认完成"按钮
- 系统更新项目状态为 `completed`
- 跳转到完成页面或项目列表

## 错误处理

### 1. 无内容错误

```typescript
if (!currentContent) {
  toast({
    title: '无内容',
    description: '请先生成文章内容',
    variant: 'destructive',
  });
  return;
}
```

### 2. LLM 调用失败

```typescript
catch (error: any) {
  toast({
    title: '审校失败',
    description: error.message || '无法完成审校',
    variant: 'destructive',
  });
}
```

### 3. 未完成所有步骤

```typescript
if (completedSteps.length < 3) {
  toast({
    title: '请完成所有审校步骤',
    variant: 'destructive',
  });
  return;
}
```

### 4. 草稿加载失败

```typescript
catch (error) {
  console.error('加载草稿失败:', error);
}
```

## 优势

### 1. 用户体验优化

- **简化流程**：三个步骤合并为一个节点，减少认知负担
- **实时反馈**：左侧实时显示审校结果，右侧显示进度
- **修改可见**：Diff 高亮清晰展示每次审校的修改内容
- **强制顺序**：确保用户按正确顺序完成审校

### 2. 视觉设计优化

- **左右分栏**：内容和操作分离，布局清晰
- **状态可视化**：图标、颜色、标记多重反馈
- **响应式布局**：适配不同屏幕尺寸
- **深色模式支持**：Diff 高亮在深色模式下也清晰可见

### 3. 技术实现优化

- **状态管理清晰**：使用 React Hooks 管理复杂状态
- **错误处理完善**：各种异常情况都有友好提示
- **性能优化**：Diff 算法高效，不影响大文本处理
- **代码可维护**：Prompt 独立定义，易于修改和优化

## 后续优化方向

### 1. 增强 Diff 显示

- 支持段落级别的对比
- 支持句子级别的对比
- 支持导出对比报告

### 2. 审校历史

- 保存每一遍审校的结果
- 支持查看历史版本
- 支持回退到某个版本

### 3. 自定义 Prompt

- 允许用户自定义审校规则
- 提供 Prompt 模板库
- 支持保存和分享 Prompt

### 4. 批量审校

- 支持一键完成三遍审校
- 支持跳过某些步骤
- 支持自定义审校顺序

### 5. AI 辅助对比

- AI 自动标注重要修改
- AI 解释修改原因
- AI 提供修改建议

## 测试清单

- [x] 左右分栏布局正常显示
- [x] Diff 高亮正确显示修改
- [x] 三个审校步骤按顺序执行
- [x] 按钮禁用逻辑正确
- [x] 状态图标和标记正确显示
- [x] LLM 调用成功返回结果
- [x] 草稿保存成功
- [x] 确认完成后状态更新
- [x] 错误处理正常工作
- [x] 响应式布局适配
- [x] 深色模式支持
- [x] 代码通过 lint 检查

## 完成状态

✅ 进度条简化完成（9 个节点 → 7 个节点）
✅ 左右分栏布局实现
✅ Diff 高亮显示实现
✅ 三个 LLM Prompt 集成
✅ 按顺序审校逻辑实现
✅ 状态管理完善
✅ 错误处理完善
✅ UI 设计优化
✅ 响应式布局实现
✅ 代码通过 lint 检查
✅ 文档编写完成

🎉 **三遍审校流程已完整实现！**

## 相关文件

- `/src/components/workflow/ReviewStage.tsx` - 审校组件
- `/src/pages/ProjectWorkflowPage.tsx` - 工作流页面
- `/src/db/api.ts` - API 函数
- `package.json` - 依赖配置（新增 diff 库）

## 依赖

- `diff`: 文本差异对比库
- `lucide-react`: 图标库（CheckCircle2, Circle, Loader2）
- `shadcn/ui`: UI 组件库
