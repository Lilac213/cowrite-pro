# 混合搜索系统文档

## 概述

CoWrite 实现了一套完整的混合搜索系统，结合学术论文搜索（OpenAlex）和实时网页搜索（Tavily），为用户提供全面、准确的研究素材。

---

## 核心设计思想

### 搜索引擎定位

- **OpenAlex** = 学术共识 / 理论基础
  - 用于搜索权威学术论文
  - 提供研究共识和理论支撑
  - 免费开放 API，无需密钥

- **Tavily** = 现实进展 / 产业 / 最新动态
  - 用于搜索实时内容和行业动态
  - 提供产业实践和最新趋势
  - 需要配置 API 密钥

### AI 的职责

**AI 的职责是对齐，而不是混写**

- 不将网页内容表述为学术共识
- 不将学术内容表述为产业实践
- 严格区分学术来源和网页来源
- 网页搜索结果仅作为现实补充信息

---

## 搜索流水线

### 整体流程

```
用户中文需求
  ↓
P1: 搜索意图拆解（学术 vs 实时）
  ↓
P2: 学术搜索转写（OpenAlex）
  ↓
P3: 实时搜索转写（Tavily）
  ↓
并行执行搜索
  ├─ OpenAlex 搜索
  └─ Tavily 搜索
  ↓
P4: 跨源结果筛选与对齐
  ↓
P5: 跨源结构化摘要
  ↓
提供给 CoWrite
```

---

## P1: 搜索意图拆解

### 功能说明

判断用户需求中哪些该去学术库，哪些该去网页搜索。

### 拆解规则

1. **学术意图**：偏向理论、方法、研究共识
2. **网页意图**：偏向行业动态、产品、政策、实践
3. 两类都可能为空或同时存在

### LLM Prompt

```
你是一名研究型搜索专家。

请分析以下【中文需求】，判断其中涉及的研究意图，
并拆解为【学术搜索意图】与【实时网页搜索意图】。

要求：
1. 学术意图：偏向理论、方法、研究共识
2. 网页意图：偏向行业动态、产品、政策、实践
3. 两类都可能为空或同时存在
4. 不要解释

输出格式（JSON）：
{
  "academic_intent": "",
  "web_intent": ""
}
```

### 示例输出

**输入：** "人工智能在医学影像中的应用"

**输出：**
```json
{
  "academic_intent": "AI techniques and research progress in medical imaging",
  "web_intent": "latest applications and industry developments of AI in medical imaging"
}
```

---

## P2: 学术搜索转写

### 功能说明

将学术意图转换为适合 OpenAlex 的英文学术关键词。

### 转写规则

1. 使用学术界常见术语
2. 覆盖研究对象 + 方法
3. 关键词 3–6 个
4. 英文输出

### LLM Prompt

```
你是一名学术搜索专家。

请将以下【学术搜索意图】转写为
【用于英文学术数据库（如 OpenAlex）检索的关键词】。

要求：
1. 使用学术界常见术语
2. 覆盖研究对象 + 方法
3. 关键词 3–6 个
4. 英文输出
5. 不要解释

输出格式（JSON）：
{
  "main_keywords": [],
  "related_keywords": []
}
```

### 示例输出

**输入：** "AI techniques and research progress in medical imaging"

**输出：**
```json
{
  "main_keywords": ["artificial intelligence", "medical imaging", "deep learning"],
  "related_keywords": ["computer vision", "diagnostic accuracy", "neural networks"]
}
```

---

## P3: 实时网页搜索转写

### 功能说明

将网页意图转换为适合 Tavily 的自然语言查询。

### 转写规则

1. 偏向自然语言，而非学术术语
2. 可包含行业、产品、应用、趋势等词
3. 不超过 2 条搜索 query
4. 英文输出

### LLM Prompt

```
你是一名实时信息检索专家。

请将以下【网页搜索意图】转写为
【适合实时网页搜索引擎（如 Tavily）使用的英文查询语句】。

要求：
1. 偏向自然语言，而非学术术语
2. 可包含行业、产品、应用、趋势等词
3. 不超过 2 条搜索 query
4. 英文输出
5. 不要解释

输出格式（JSON）：
{
  "queries": []
}
```

### 示例输出

**输入：** "latest applications and industry developments of AI in medical imaging"

**输出：**
```json
{
  "queries": [
    "latest AI applications in medical imaging industry",
    "AI medical imaging startups and products 2025"
  ]
}
```

### 关键区别

- **OpenAlex** = 精准学术术语
- **Tavily** = 自然语言 + 新、杂、快

---

## P4: 跨源结果筛选与对齐

### 功能说明

对齐来自 OpenAlex 和 Tavily 的搜索结果，识别主题一致的部分，剔除无关内容。

### 对齐规则

1. 识别两类内容中主题一致的部分
2. 标记哪些网页内容是对学术研究的现实补充
3. 剔除明显无关或噪声内容
4. **不合并写作**，仅做筛选与分类

### LLM Prompt

```
你是一名研究整合助手。

请基于以下两类搜索结果：
1. 学术论文结果（OpenAlex）
2. 实时网页搜索结果（Tavily）

完成以下任务：
- 识别两类内容中【主题一致的部分】
- 标记哪些网页内容是对学术研究的现实补充
- 剔除明显无关或噪声内容

要求：
1. 不合并写作
2. 仅做筛选与分类
3. 输出结构化结果

输出格式（JSON）：
{
  "academic_core": [],
  "web_supporting": [],
  "discarded": []
}
```

### 输出说明

- **academic_core**：用于研究共识
- **web_supporting**：用于现实案例 / 现状
- **discarded**：不给 CoWrite

---

## P5: 跨源结构化摘要

### 功能说明

基于对齐后的结果，生成结构化的研究素材，严格区分学术内容和网页内容。

### 摘要规则

1. 学术内容与网页内容分开展示
2. 不新增结论
3. **不将网页内容表述为学术共识**
4. 中文输出

### LLM Prompt

```
你是一名专业研究助手。

请基于以下【学术核心内容】与【网页补充内容】，整理
【可供专业写作使用的结构化研究素材】。

要求：
1. 学术内容与网页内容分开展示
2. 不新增结论
3. 不将网页内容表述为学术共识
4. 中文输出

输出格式（JSON）：
{
  "academic_consensus": [],
  "industry_practice": [],
  "recent_trends": []
}
```

### 示例输出

```json
{
  "academic_consensus": [
    "深度学习已成为医学影像分析的主流方法",
    "AI 在影像识别任务中显著提升诊断效率"
  ],
  "industry_practice": [
    "多家医疗影像公司已推出 AI 辅助诊断产品",
    "AI 系统开始在部分医院进行临床试点"
  ],
  "recent_trends": [
    "监管机构开始制定 AI 医疗器械审批规范"
  ]
}
```

### 输出说明

- **academic_consensus**：学术共识（来自 OpenAlex）
- **industry_practice**：产业实践（来自 Tavily）
- **recent_trends**：最新趋势（来自 Tavily）

👉 **这个 JSON 就是 CoWrite 的"黄金输入"**

---

## 强约束规则

### 规则 1：严格区分来源

- 学术论文结果标记为 `source: 'OpenAlex'`
- 网页搜索结果标记为 `source: 'Tavily'`
- 在知识库中分别显示

### 规则 2：禁止混合推理

- 网页搜索结果仅作为现实补充信息
- **不得用于生成学术结论或研究共识**
- AI 只负责对齐和分类，不负责混合写作

### 规则 3：更新频率建议

- 学术论文：建议 30 天后更新
- 网页内容：建议 7 天后更新

---

## 技术实现

### Edge Functions

#### openalex-search

- **路径**：`supabase/functions/openalex-search/index.ts`
- **功能**：调用 OpenAlex API 搜索学术论文
- **参数**：
  - `query`: 搜索关键词
  - `yearStart`: 起始年份（默认 2020）
  - `yearEnd`: 结束年份（默认当前年份）
- **返回**：
  ```json
  {
    "papers": [
      {
        "title": "论文标题",
        "authors": "作者列表",
        "year": "发表年份",
        "abstract": "摘要",
        "citations": 引用数,
        "url": "DOI 链接",
        "source": "OpenAlex"
      }
    ],
    "total": 总数
  }
  ```

#### tavily-search

- **路径**：`supabase/functions/tavily-search/index.ts`
- **功能**：调用 Tavily API 进行实时网页搜索
- **参数**：
  - `query`: 搜索查询
- **环境变量**：
  - `TAVILY_API_KEY`: Tavily API 密钥
- **返回**：
  ```json
  {
    "summary": "AI 生成的摘要",
    "papers": [
      {
        "title": "网页标题",
        "authors": "Tavily Search",
        "year": "当前年份",
        "abstract": "网页内容",
        "citations": 0,
        "url": "网页链接",
        "source": "Tavily"
      }
    ],
    "sources": [
      {
        "url": "来源链接",
        "title": "来源标题"
      }
    ],
    "total": 总数
  }
  ```

### API Functions

#### searchIntentDecomposer

- **文件**：`src/db/api.ts`
- **功能**：P1 - 搜索意图拆解
- **参数**：`userQueryZh: string`
- **返回**：`{ academic_intent: string, web_intent: string }`

#### academicSearchRewritingV2

- **文件**：`src/db/api.ts`
- **功能**：P2 - 学术搜索转写
- **参数**：`academicIntent: string`
- **返回**：`{ main_keywords: string[], related_keywords: string[] }`

#### webSearchRewriting

- **文件**：`src/db/api.ts`
- **功能**：P3 - 实时网页搜索转写
- **参数**：`webIntent: string`
- **返回**：`{ queries: string[] }`

#### crossSourceAligner

- **文件**：`src/db/api.ts`
- **功能**：P4 - 跨源结果筛选与对齐
- **参数**：`academicResults: any[], webResults: any[]`
- **返回**：`{ academic_core: any[], web_supporting: any[], discarded: any[] }`

#### crossSourceStructuredSummary

- **文件**：`src/db/api.ts`
- **功能**：P5 - 跨源结构化摘要
- **参数**：`academicCore: any[], webSupporting: any[]`
- **返回**：`{ academic_consensus: string[], industry_practice: string[], recent_trends: string[] }`

#### academicSearchWorkflow

- **文件**：`src/db/api.ts`
- **功能**：完整的混合搜索工作流
- **参数**：`userQueryZh: string`
- **返回**：
  ```typescript
  {
    intentDecomposition: { academic_intent: string, web_intent: string },
    academicKeywords: { main_keywords: string[], related_keywords: string[] },
    webQueries: { queries: string[] },
    academicPapers: any[],
    webPapers: any[],
    alignedResults: { academic_core: any[], web_supporting: any[], discarded: any[] },
    structuredSummary: { academic_consensus: string[], industry_practice: string[], recent_trends: string[] }
  }
  ```

---

## UI 展示

### 搜索分析卡片

显示混合搜索的分析结果，包括：

1. **搜索意图拆解**
   - 学术意图（蓝色背景）
   - 实时意图（绿色背景）

2. **学术关键词（OpenAlex）**
   - 主要关键词（default badge）
   - 相关关键词（outline badge）

3. **网页搜索查询（Tavily）**
   - 自然语言查询（secondary badge）

4. **结构化研究素材**
   - 学术共识（蓝色背景）
   - 产业实践（绿色背景）
   - 最新趋势（紫色背景）

### 知识库列表

- 学术论文显示 `source: 'OpenAlex'`
- 网页内容显示 `source: 'Tavily'`
- 分别标记不同的更新建议

---

## 配置说明

### OpenAlex

- **状态**：已启用
- **API 密钥**：不需要
- **说明**：OpenAlex 是免费开放的学术搜索 API

### Tavily

- **状态**：需配置
- **API 密钥**：在管理面板配置 `TAVILY_API_KEY`
- **获取方式**：访问 https://tavily.com 注册账号获取
- **说明**：Tavily 提供高质量的实时搜索结果

---

## 使用流程

### 用户操作

1. 进入项目的"资料查询"阶段
2. 输入中文研究需求（如"人工智能在医学影像中的应用"）
3. 点击"智能搜索"按钮
4. 系统自动执行混合搜索流水线
5. 查看搜索分析结果
6. 勾选需要的知识库条目
7. 点击"确认选择"进入下一阶段

### 系统处理

1. **P1**：拆解搜索意图
2. **P2**：转写学术关键词
3. **P3**：转写网页查询
4. **并行搜索**：OpenAlex + Tavily
5. **P4**：对齐搜索结果
6. **P5**：生成结构化摘要
7. **保存**：存入知识库
8. **展示**：显示搜索分析

---

## 最佳实践

### 搜索关键词建议

- **学术研究**：使用专业术语，如"深度学习"、"神经网络"
- **产业应用**：使用自然语言，如"AI 医疗产品"、"行业应用"
- **综合需求**：系统会自动拆解为学术和实时两部分

### 结果筛选建议

- 优先选择学术论文作为理论支撑
- 选择网页内容作为现实案例补充
- 注意区分学术共识和产业实践

### 写作使用建议

- 学术共识用于理论部分
- 产业实践用于应用部分
- 最新趋势用于展望部分

---

## 常见问题

### Q1: 为什么要区分学术和网页搜索？

**A**: 学术论文提供理论基础和研究共识，网页内容提供产业实践和最新动态。两者来源不同，可信度不同，应用场景不同，必须严格区分。

### Q2: Tavily 搜索失败怎么办？

**A**: 如果 Tavily API 密钥未配置或搜索失败，系统会继续使用 OpenAlex 的学术搜索结果，不影响整体流程。

### Q3: 如何判断搜索结果的质量？

**A**: 
- 学术论文：查看引用数、发表年份、来源期刊
- 网页内容：查看来源网站、发布时间、内容相关性

### Q4: 搜索结果太多怎么办？

**A**: 系统会自动筛选和对齐结果，只保留高质量和相关性强的内容。用户可以进一步勾选需要的条目。

### Q5: 如何更新搜索结果？

**A**: 
- 学术论文：建议 30 天后重新搜索
- 网页内容：建议 7 天后重新搜索
- 系统会在知识库中记录更新建议

---

## 未来优化方向

### 搜索优化

1. 支持更多学术数据库（如 Semantic Scholar、arXiv）
2. 支持中文学术搜索（如知网、万方）
3. 支持自定义搜索引擎权重

### 结果优化

1. 自动去重相似论文
2. 智能推荐相关研究
3. 生成研究脉络图

### 交互优化

1. 支持搜索历史
2. 支持搜索结果导出
3. 支持批量操作

---

🎉 **混合搜索系统已完成！**
