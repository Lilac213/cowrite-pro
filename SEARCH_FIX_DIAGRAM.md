# ğŸ”„ æœç´¢åŠŸèƒ½æ•°æ®æµä¿®å¤å¯¹æ¯”

## ä¿®å¤å‰çš„æ•°æ®æµï¼ˆæœ‰é—®é¢˜ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: research-retrieval-agent                      â”‚
â”‚                                                               â”‚
â”‚ è¿”å›:                                                         â”‚
â”‚ {                                                             â”‚
â”‚   success: true,                                              â”‚
â”‚   data: {                                                     â”‚
â”‚     academic_sources: [5æ¡],                                  â”‚
â”‚     news_sources: [3æ¡],                                      â”‚
â”‚     web_sources: [7æ¡]                                        â”‚
â”‚   }                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api.ts: researchRetrievalAgent                               â”‚
â”‚                                                               â”‚
â”‚ âŒ é—®é¢˜ä»£ç :                                                  â”‚
â”‚ return data;  // ç›´æ¥è¿”å›æ•´ä¸ªå“åº”                             â”‚
â”‚                                                               â”‚
â”‚ è¿”å›ç»™ç»„ä»¶:                                                   â”‚
â”‚ {                                                             â”‚
â”‚   success: true,      // âŒ ç»„ä»¶ä¸æœŸæœ›è¿™ä¸ªå­—æ®µ                â”‚
â”‚   data: {             // âŒ å¤šäº†ä¸€å±‚åµŒå¥—                      â”‚
â”‚     academic_sources: [...],                                  â”‚
â”‚     news_sources: [...],                                      â”‚
â”‚     web_sources: [...]                                        â”‚
â”‚   }                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KnowledgeStage ç»„ä»¶                                           â”‚
â”‚                                                               â”‚
â”‚ âŒ é—®é¢˜ä»£ç :                                                  â”‚
â”‚ const allSources = [                                          â”‚
â”‚   ...(retrievalResults.academic_sources || []),  // undefined â”‚
â”‚   ...(retrievalResults.news_sources || []),      // undefined â”‚
â”‚   ...(retrievalResults.web_sources || [])        // undefined â”‚
â”‚ ];                                                            â”‚
â”‚                                                               â”‚
â”‚ ç»“æœ:                                                         â”‚
â”‚ allSources.length === 0  // âŒ æ˜¾ç¤º "æ‰¾åˆ° 0 ç¯‡æ–‡ç« "           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¿®å¤åçš„æ•°æ®æµï¼ˆæ­£ç¡®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function: research-retrieval-agent                      â”‚
â”‚                                                               â”‚
â”‚ è¿”å›:                                                         â”‚
â”‚ {                                                             â”‚
â”‚   success: true,                                              â”‚
â”‚   data: {                                                     â”‚
â”‚     academic_sources: [5æ¡],                                  â”‚
â”‚     news_sources: [3æ¡],                                      â”‚
â”‚     web_sources: [7æ¡]                                        â”‚
â”‚   }                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api.ts: researchRetrievalAgent                               â”‚
â”‚                                                               â”‚
â”‚ âœ… ä¿®å¤ä»£ç :                                                  â”‚
â”‚ if (data.success && data.data) {                             â”‚
â”‚   return data.data;  // âœ… æå–åµŒå¥—çš„ data å­—æ®µ              â”‚
â”‚ }                                                             â”‚
â”‚ return data;                                                  â”‚
â”‚                                                               â”‚
â”‚ è¿”å›ç»™ç»„ä»¶:                                                   â”‚
â”‚ {                                                             â”‚
â”‚   academic_sources: [5æ¡],  // âœ… ç›´æ¥è®¿é—®                    â”‚
â”‚   news_sources: [3æ¡],                                        â”‚
â”‚   web_sources: [7æ¡]                                          â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KnowledgeStage ç»„ä»¶                                           â”‚
â”‚                                                               â”‚
â”‚ âœ… æ­£ç¡®ä»£ç :                                                  â”‚
â”‚ const allSources = [                                          â”‚
â”‚   ...(retrievalResults.academic_sources || []),  // [5æ¡]    â”‚
â”‚   ...(retrievalResults.news_sources || []),      // [3æ¡]    â”‚
â”‚   ...(retrievalResults.web_sources || [])        // [7æ¡]    â”‚
â”‚ ];                                                            â”‚
â”‚                                                               â”‚
â”‚ ç»“æœ:                                                         â”‚
â”‚ allSources.length === 15  // âœ… æ˜¾ç¤º "æ‰¾åˆ° 15 ç¯‡æ–‡ç« "         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®ä¿®å¤ç‚¹

### 1. æ•°æ®ç»“æ„æ£€æµ‹

```typescript
// ä¿®å¤å‰
return data;  // âŒ ä¸æ£€æŸ¥æ•°æ®ç»“æ„

// ä¿®å¤å
if (data.success && data.data) {
  return data.data;  // âœ… æå–åµŒå¥—çš„ data å­—æ®µ
}
return data;  // âœ… å…¼å®¹å…¶ä»–æ ¼å¼
```

### 2. æ—¥å¿—å¢å¼º

```typescript
// ä¿®å¤å‰
// æ²¡æœ‰æ—¥å¿—ï¼Œæ— æ³•è°ƒè¯•

// ä¿®å¤å
console.log('[researchRetrievalAgent] å¼€å§‹è°ƒç”¨ï¼Œéœ€æ±‚æ–‡æ¡£:', requirementsDoc);
console.log('[researchRetrievalAgent] Edge Function å“åº”:', { data, error });
console.log('[researchRetrievalAgent] æå– data å­—æ®µ:', data.data);
```

### 3. é”™è¯¯å¤„ç†

```typescript
// ä¿®å¤å‰
if (error) {
  throw new Error(error.message);  // âŒ é”™è¯¯ä¿¡æ¯ä¸è¯¦ç»†
}

// ä¿®å¤å
if (error) {
  // âœ… å°è¯•æå–è¯¦ç»†é”™è¯¯ä¿¡æ¯
  let errorMessage = error.message || 'èµ„æ–™æ£€ç´¢å¤±è´¥';
  
  if (error.context) {
    // æå– context ä¸­çš„è¯¦ç»†é”™è¯¯
  }
  
  if (data && typeof data === 'object' && 'error' in data) {
    errorMessage = data.error;
  }
  
  throw new Error(errorMessage);
}
```

---

## æ•°æ®ç»“æ„å¯¹æ¯”

### Edge Function å“åº”ï¼ˆå®é™…ï¼‰

```json
{
  "success": true,
  "data": {
    "search_summary": {
      "interpreted_topic": "AI Agentåº”ç”¨çš„å•†ä¸šåŒ–è·¯å¾„",
      "key_dimensions": ["å•†ä¸šåŒ–ç­–ç•¥", "ç”¨æˆ·å®šä½"]
    },
    "academic_sources": [
      { "title": "...", "authors": "...", "abstract": "...", ... }
    ],
    "news_sources": [
      { "title": "...", "source": "...", "summary": "...", ... }
    ],
    "web_sources": [
      { "title": "...", "site_name": "...", "snippet": "...", ... }
    ],
    "user_library_sources": [],
    "personal_sources": []
  },
  "raw_content": "..."
}
```

### ç»„ä»¶æœŸæœ›ï¼ˆåº”è¯¥æ¥æ”¶ï¼‰

```json
{
  "search_summary": {
    "interpreted_topic": "AI Agentåº”ç”¨çš„å•†ä¸šåŒ–è·¯å¾„",
    "key_dimensions": ["å•†ä¸šåŒ–ç­–ç•¥", "ç”¨æˆ·å®šä½"]
  },
  "academic_sources": [
    { "title": "...", "authors": "...", "abstract": "...", ... }
  ],
  "news_sources": [
    { "title": "...", "source": "...", "summary": "...", ... }
  ],
  "web_sources": [
    { "title": "...", "site_name": "...", "snippet": "...", ... }
  ],
  "user_library_sources": [],
  "personal_sources": []
}
```

### ä¿®å¤å‰ api.ts è¿”å›ï¼ˆé”™è¯¯ï¼‰

```json
{
  "success": true,      // âŒ å¤šä½™å­—æ®µ
  "data": {             // âŒ åµŒå¥—å±‚çº§
    "search_summary": {...},
    "academic_sources": [...],
    ...
  },
  "raw_content": "..."  // âŒ å¤šä½™å­—æ®µ
}
```

### ä¿®å¤å api.ts è¿”å›ï¼ˆæ­£ç¡®ï¼‰

```json
{
  "search_summary": {...},
  "academic_sources": [...],  // âœ… ç›´æ¥è®¿é—®
  "news_sources": [...],
  "web_sources": [...],
  "user_library_sources": [],
  "personal_sources": []
}
```

---

## è®¿é—®è·¯å¾„å¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰

```javascript
// ç»„ä»¶å°è¯•è®¿é—®
retrievalResults.academic_sources
// å®é™…è·¯å¾„: retrievalResults.data.academic_sources
// ç»“æœ: undefined âŒ

retrievalResults.news_sources
// å®é™…è·¯å¾„: retrievalResults.data.news_sources
// ç»“æœ: undefined âŒ

retrievalResults.web_sources
// å®é™…è·¯å¾„: retrievalResults.data.web_sources
// ç»“æœ: undefined âŒ

// æœ€ç»ˆ
allSources.length === 0  // âŒ
```

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰

```javascript
// ç»„ä»¶è®¿é—®
retrievalResults.academic_sources
// å®é™…è·¯å¾„: retrievalResults.academic_sources
// ç»“æœ: [5æ¡] âœ…

retrievalResults.news_sources
// å®é™…è·¯å¾„: retrievalResults.news_sources
// ç»“æœ: [3æ¡] âœ…

retrievalResults.web_sources
// å®é™…è·¯å¾„: retrievalResults.web_sources
// ç»“æœ: [7æ¡] âœ…

// æœ€ç»ˆ
allSources.length === 15  // âœ…
```

---

## ä¿®å¤éªŒè¯

### æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—

```javascript
// ä¿®å¤å‰ï¼ˆçœ‹ä¸åˆ°è¿™äº›æ—¥å¿—ï¼‰
// æ— æ—¥å¿—

// ä¿®å¤åï¼ˆèƒ½çœ‹åˆ°è¯¦ç»†æ—¥å¿—ï¼‰
[researchRetrievalAgent] å¼€å§‹è°ƒç”¨ï¼Œéœ€æ±‚æ–‡æ¡£: {...}
[researchRetrievalAgent] Edge Function å“åº”: {
  data: { success: true, data: {...} },
  error: null
}
[researchRetrievalAgent] æå– data å­—æ®µ: {
  academic_sources: [5æ¡],
  news_sources: [3æ¡],
  web_sources: [7æ¡]
}
[KnowledgeStage] æ‰€æœ‰æ¥æºæ•°é‡: 15
[KnowledgeStage] æ¥æºè¯¦æƒ…: {
  academic: 5,
  news: 3,
  web: 7,
  user_library: 0,
  personal: 0
}
```

### ç”¨æˆ·ç•Œé¢æ˜¾ç¤º

```
ä¿®å¤å‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èµ„æ–™æŸ¥è¯¢: ä» 5 ä¸ªæ•°æ®æºæ£€ç´¢     â”‚
â”‚ âŒ æ‰¾åˆ° 0 ç¯‡æ–‡ç«                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¿®å¤å:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èµ„æ–™æŸ¥è¯¢: ä» 5 ä¸ªæ•°æ®æºæ£€ç´¢     â”‚
â”‚ âœ… æ‰¾åˆ° 15 ç¯‡æ–‡ç«                â”‚
â”‚                                 â”‚
â”‚ ğŸ“š å­¦æœ¯æ¥æº: 5 æ¡               â”‚
â”‚ ğŸ“° æ–°é—»æ¥æº: 3 æ¡               â”‚
â”‚ ğŸŒ ç½‘ç»œæ¥æº: 7 æ¡               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ€»ç»“

### é—®é¢˜æ ¹æº
**æ•°æ®ç»“æ„ä¸åŒ¹é…**: Edge Function è¿”å›çš„æ˜¯åµŒå¥—ç»“æ„ `{ success: true, data: {...} }`ï¼Œä½†å‰ç«¯ç›´æ¥è¿”å›æ•´ä¸ªå¯¹è±¡ï¼Œå¯¼è‡´ç»„ä»¶æ— æ³•è®¿é—®æ­£ç¡®çš„å­—æ®µã€‚

### è§£å†³æ–¹æ¡ˆ
**æ•°æ®æå–**: åœ¨ api.ts ä¸­æ£€æµ‹å“åº”æ ¼å¼ï¼Œå¦‚æœæ˜¯ `{ success: true, data: {...} }` æ ¼å¼ï¼Œåˆ™æå– `data` å­—æ®µè¿”å›ç»™ç»„ä»¶ã€‚

### ä¿®å¤æ•ˆæœ
- âœ… æœç´¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… æ­£ç¡®æ˜¾ç¤ºæ–‡ç« æ•°é‡
- âœ… æ–‡ç« èƒ½æ­£ç¡®ä¿å­˜åˆ°çŸ¥è¯†åº“
- âœ… æ—¥å¿—æ¸…æ™°ï¼Œä¾¿äºè°ƒè¯•

---

**ä¿®å¤æ—¶é—´**: 2025-02-06  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•**: è®¿é—® `/search-debug` ç«‹å³æµ‹è¯•
