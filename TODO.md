# 任务：邀请码和积分系统升级

## 完成情况

### ✅ 已完成

#### 1. 数据库架构升级
- [x] 修改积分系统
  - 移除 ai_reducer_limit 和 project_limit 字段
  - 将 credits 重命名为 available_credits（可用点数）
  - 添加 unlimited_credits 字段（管理员无限点数标识）
  - 只保留使用次数记录（ai_reducer_used, projects_created）
- [x] 更新邀请码表
  - 移除 ai_reducer_limit 和 project_limit
  - 添加 credits 字段（赠送点数）
- [x] 创建订单表（orders）
  - 支持 Stripe 支付
  - 订单状态管理（pending, completed, cancelled, refunded）
  - 关联用户和支付信息

#### 2. Stripe 支付集成
- [x] 创建 create_stripe_checkout Edge Function
  - 创建支付会话
  - 生成订单记录
  - 支持支付宝、微信支付、信用卡
- [x] 创建 verify_stripe_payment Edge Function
  - 验证支付状态
  - 更新订单状态
  - 自动充值用户点数
- [x] 创建支付成功页面（PaymentSuccessPage）
  - 验证支付结果
  - 显示订单信息
  - 引导用户返回

#### 3. 管理员功能
- [x] 用户点数配置
  - 为任意用户设置可用点数
  - 显示用户无限点数状态
  - 管理员自动获得无限点数
- [x] 邀请码生成简化
  - 只需设置赠送点数
  - 移除复杂的限制配置
- [x] 用户列表增强
  - 显示可用点数（普通用户）或无限标识（管理员）
  - 显示 AI 降重使用次数
  - 显示项目创建数量
  - 配置点数按钮

#### 4. 用户设置页面
- [x] 使用情况单行显示
  - 可用点数 | AI降重次数 | 项目数量
  - 管理员显示"无限"标识
- [x] 购买点数简化
  - 只显示价格和点数
  - 移除详细的增加说明
  - 点击购买跳转 Stripe 支付页面
- [x] 套餐配置
  - 体验包：16点 ¥9.9
  - 推荐包⭐：66点 ¥29.9
  - 进阶包：166点 ¥79.9
  - 专业包：366点 ¥149.9

#### 5. AI降重页面
- [x] 使用情况单行显示
  - 已使用次数 · 剩余点数
  - 管理员显示"无限"
- [x] 点数检查
  - 使用前检查可用点数
  - 使用后自动扣除1点
  - 管理员不扣点数
- [x] 点数不足提示
  - 显示购买点数按钮
  - 禁用输入和处理功能

#### 6. 项目列表页面
- [x] 项目配额单行显示
  - 已创建数量 · 剩余点数
  - 管理员显示"无限"
- [x] 点数检查
  - 创建前检查可用点数
  - 创建后自动扣除1点
  - 管理员不扣点数
- [x] 配额不足提示
  - 显示购买点数按钮
  - 禁用新建项目功能

#### 7. 类型和API更新
- [x] 更新 Profile 类型
  - available_credits: 可用点数
  - unlimited_credits: 无限点数标识
  - 移除 limit 字段
- [x] 更新 InvitationCode 类型
  - credits: 赠送点数
  - 移除 limit 字段
- [x] 新增 Order 类型
  - 订单完整信息
  - Stripe 支付数据
- [x] API 函数更新
  - setUserCredits: 管理员配置用户点数
  - getUserOrders: 获取用户订单
  - getOrder: 获取订单详情
  - 更新点数检查和扣除逻辑

## 功能说明

### 积分系统
1. **可用点数**：用户的点数余额，用于使用各项功能
2. **使用记录**：只记录使用次数，不设置上限
3. **管理员特权**：无限点数，不受限制
4. **点数消耗**：
   - AI降重：每次消耗1点
   - 创建项目：每次消耗1点

### 邀请码系统
1. 管理员生成邀请码，设置赠送点数
2. 用户注册时可填写邀请码
3. 使用邀请码后获得对应点数
4. 邀请码可多次使用

### 支付系统
1. **Stripe 集成**：
   - 支持支付宝、微信支付、信用卡
   - 安全的支付流程
   - 自动充值点数
2. **购买流程**：
   - 选择套餐 → 跳转 Stripe → 完成支付 → 自动充值
3. **订单管理**：
   - 记录所有支付订单
   - 支持订单查询
   - 支付状态跟踪

## 注意事项

1. **Stripe 配置**：需要在环境变量中配置 STRIPE_SECRET_KEY
2. **货币设置**：默认使用人民币（CNY）
3. **支付方式**：支持 card、alipay、wechat_pay
4. **安全性**：所有支付逻辑在 Edge Function 中处理
5. **点数充值**：支付成功后自动充值，无需手动操作

