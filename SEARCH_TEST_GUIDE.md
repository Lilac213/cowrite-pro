# 🧪 搜索功能测试指南

## 快速测试步骤

### 方法 1: 使用搜索调试页面（推荐）

1. **访问调试页面**
   ```
   URL: /search-debug
   ```

2. **执行测试**
   - 查看默认的需求文档（或修改为自己的测试数据）
   - 点击"开始搜索"按钮
   - 等待搜索完成（通常 3-10 秒）

3. **查看结果**
   - ✅ 执行日志：显示搜索流程的每个步骤
   - ✅ 搜索结果统计：显示各数据源的文章数量
   - ✅ 搜索结果详情：显示具体的文章标题、摘要等
   - ✅ 原始响应数据：显示完整的 JSON 响应

4. **预期结果**
   ```
   📊 搜索结果统计:
      - 学术来源: 5-10 条
      - 新闻来源: 3-10 条
      - 网络来源: 5-10 条
      - 用户库来源: 0 条
      - 总计: 15-30 条
   ```

### 方法 2: 在实际项目中测试

1. **创建新项目**
   - 访问首页
   - 点击"新建项目"
   - 输入项目标题，例如："AI Agent 商业化研究"

2. **进入需求阶段**
   - 系统会自动进入需求阶段
   - 填写需求文档或使用 AI 生成

3. **进入知识阶段**
   - 点击"下一步"进入知识阶段
   - 系统会自动根据需求文档执行搜索

4. **查看搜索结果**
   - 观察进度提示
   - 查看"找到 X 篇文章"的提示
   - 查看知识库中的文章列表

5. **预期结果**
   - ✅ 进度显示："资料查询: 从 5 个数据源检索"
   - ✅ 成功提示："搜索完成！已从 5 个数据源检索并整理了 X 条资料"
   - ✅ 知识库显示：列出所有检索到的文章
   - ✅ 文章数量：15-30 条（取决于搜索结果）

## 查看日志

### 浏览器控制台日志

1. **打开控制台**
   - Windows/Linux: `F12` 或 `Ctrl+Shift+I`
   - Mac: `Cmd+Option+I`

2. **切换到 Console 标签**

3. **查找关键日志**
   ```javascript
   // 搜索开始
   [KnowledgeStage] 调用 agentDrivenResearchWorkflow

   // API 调用
   [researchRetrievalAgent] 开始调用
   [researchRetrievalAgent] Edge Function 响应

   // 数据提取
   [researchRetrievalAgent] 提取 data 字段

   // 结果统计
   [KnowledgeStage] 所有来源数量: 15
   [KnowledgeStage] 来源详情: { academic: 5, news: 3, web: 7, ... }
   ```

4. **检查错误**
   - 红色的错误信息
   - 包含 "Error" 或 "失败" 的日志

### Edge Function 日志

1. **登录 Supabase Dashboard**
   - 访问 Supabase 控制台
   - 选择项目：`app-9bwpferlujnl`

2. **导航到 Edge Functions**
   - 左侧菜单 → Edge Functions
   - 选择 `research-retrieval-agent`
   - 点击 "Logs" 标签

3. **查找关键日志**
   ```
   ========== 接收到的请求参数 ==========
   ========== API Keys 状态检查 ==========
   ========== 开始调用通义千问 API ==========
   ========== Google Scholar 搜索开始 ==========
   ========== TheNews 搜索开始 ==========
   ========== Smart Search 搜索开始 ==========
   ========== 最终结果统计 ==========
   ```

4. **检查错误**
   - 包含 "❌" 或 "错误" 的日志
   - HTTP 状态码不是 200 的请求
   - API 返回的错误信息

## 常见测试场景

### 场景 1: 正常搜索

**输入**:
```json
{
  "主题": "AI Agent应用的商业化路径",
  "关键要点": ["商业化策略", "用户定位"],
  "核心观点": ["AI Agent的商业价值"],
  "目标读者": "企业决策者",
  "写作风格": "专业分析",
  "预期长度": "中等"
}
```

**预期结果**:
- ✅ 搜索成功
- ✅ 返回 15-30 条文章
- ✅ 包含学术、新闻、网络来源

### 场景 2: 简单主题

**输入**:
```json
{
  "主题": "人工智能",
  "关键要点": ["机器学习"],
  "核心观点": [],
  "目标读者": "通用读者",
  "写作风格": "通俗",
  "预期长度": "短"
}
```

**预期结果**:
- ✅ 搜索成功
- ✅ 返回 10-20 条文章
- ✅ 关键词更通用，结果更广泛

### 场景 3: 专业主题

**输入**:
```json
{
  "主题": "Transformer模型在NLP中的应用",
  "关键要点": ["注意力机制", "预训练模型", "微调策略"],
  "核心观点": ["Transformer革新了NLP领域"],
  "目标读者": "技术研究人员",
  "写作风格": "学术",
  "预期长度": "长"
}
```

**预期结果**:
- ✅ 搜索成功
- ✅ 学术来源较多（8-10 条）
- ✅ 包含高引用论文

## 问题排查清单

### ✅ 搜索成功的标志

- [ ] 浏览器控制台显示 `[KnowledgeStage] 所有来源数量: X`（X > 0）
- [ ] 搜索调试页面显示"搜索结果统计"
- [ ] 知识库中显示文章列表
- [ ] 没有红色错误信息

### ❌ 搜索失败的标志

- [ ] 显示"找到 0 篇文章"
- [ ] 浏览器控制台有红色错误
- [ ] Edge Function 日志显示错误
- [ ] 搜索一直卡在某个阶段

### 🔍 如果搜索失败

1. **检查 API Keys**
   - Edge Function 日志中查看 "API Keys 状态检查"
   - 确认 QIANWEN_API_KEY 和 INTEGRATIONS_API_KEY 都存在

2. **检查数据结构**
   - 浏览器控制台查看 `[researchRetrievalAgent] Edge Function 响应`
   - 确认返回的数据结构正确

3. **检查外部 API**
   - Edge Function 日志中查看各数据源的响应状态
   - 确认响应状态码为 200
   - 确认返回的数据不为空

4. **检查搜索计划**
   - Edge Function 日志中查看 "搜索计划"
   - 确认 academic_queries、news_queries、web_queries 都有值

## 性能基准

### 正常响应时间

- **搜索计划生成**: 1-3 秒
- **外部 API 搜索**: 2-5 秒
- **资料整理**: 2-4 秒
- **总计**: 5-12 秒

### 如果超过 15 秒

- 检查网络连接
- 检查外部 API 是否可用
- 检查通义千问 API 是否响应慢

## 测试报告模板

如果需要报告问题，请提供以下信息：

```markdown
## 测试环境
- 测试时间: [时间]
- 测试方法: [搜索调试页面 / 实际项目]
- 浏览器: [Chrome / Firefox / Safari]

## 测试输入
```json
{
  "主题": "...",
  "关键要点": [...],
  ...
}
```

## 实际结果
- 搜索状态: [成功 / 失败]
- 文章数量: [X 条]
- 响应时间: [X 秒]

## 浏览器控制台日志
```
[粘贴关键日志]
```

## Edge Function 日志
```
[粘贴关键日志]
```

## 错误信息
```
[粘贴错误信息]
```

## 截图
[附上截图]
```

---

**更新时间**: 2025-02-06
**版本**: 1.0
**状态**: ✅ 可用
