# 学术搜索工作流实现文档

## 概述

实现了完整的 5 阶段学术搜索工作流，将用户的中文研究需求转换为高质量的学术资料和写作素材。

## 工作流架构

```
用户中文需求
    ↓
P1: 学术搜索转写 (LLM)
    ↓
英文学术关键词
    ↓
P2: 搜索意图澄清 (LLM)
    ↓
搜索范围定义
    ↓
OpenAlex 搜索
    ↓
P3: Top N 论文筛选 (LLM)
    ↓
高质量论文子集
    ↓
P4: 结构化学术摘要 (LLM)
    ↓
学术共识要点
    ↓
P5: CoWrite 输入整理 (LLM)
    ↓
可直接写作的结构化素材
```

## 五个 Prompt 详解

### P1: 学术搜索转写 (Academic Search Rewriting)

**作用：** 将中文研究需求转换为英文学术数据库关键词

**输入：** 用户的中文研究需求
**输出：** JSON 格式的主关键词和相关关键词

```json
{
  "main_keywords": ["artificial intelligence", "medical imaging", "deep learning"],
  "related_keywords": ["computer-aided diagnosis", "radiology AI", "image segmentation"]
}
```

**关键要求：**
- 使用学术界常见术语，而不是直译
- 关键词需覆盖研究对象 + 技术方法
- 关键词数量 3–6 个
- 必须为英文

**实现函数：** `academicSearchRewriting(userQueryZh: string)`

### P2: 搜索意图澄清 (Search Scope Clarifier)

**作用：** 判断用户的研究关注重点，避免搜索范围过宽或过偏

**输入：** 英文学术关键词数组
**输出：** JSON 格式的研究关注重点

```json
{
  "focus": ["方法与技术原理", "应用场景与实践"]
}
```

**关注重点类别：**
- A. 方法与技术原理
- B. 应用场景与实践
- C. 性能评估与对比
- D. 挑战、限制与问题
- E. 研究趋势与综述

**实现函数：** `searchScopeClarifier(academicKeywords: string[])`

### P3: Top N 论文筛选 (Top Paper Selector)

**作用：** 从 OpenAlex 返回的大量论文中筛选最具代表性的 3-6 篇

**输入：** 研究主题 + 论文列表
**输出：** JSON 格式的被选论文索引

```json
{
  "selected_indexes": [0, 2, 5, 8]
}
```

**筛选标准：**
1. 与研究主题高度相关
2. 发表时间较新（优先近 3–5 年）
3. 具有一定引用影响力
4. 内容具有代表性，而非细分噪声

**实现函数：** `topPaperSelector(searchTopic: string, papers: any[])`

**重要性：** 这是"去噪声"的关键闸门，决定后续内容质量

### P4: 结构化学术摘要 (Academic Consensus Extractor)

**作用：** 提炼学术研究共识要点，作为事实锚点

**输入：** 筛选后的论文列表
**输出：** JSON 数组格式的学术共识要点

```json
[
  "深度学习方法被广泛用于医学影像特征提取",
  "AI 辅助诊断在多类影像任务中提升准确率",
  "高质量标注数据对模型性能具有显著影响",
  "临床应用仍受可解释性与监管要求限制"
]
```

**关键要求：**
1. 仅基于提供的论文摘要内容
2. 不引入外部知识
3. 不进行推测或预测
4. 使用客观、中性表述
5. 输出 3–6 条
6. 每条不超过 40 字
7. 不出现"本文认为 / 我们认为"等主观表达

**实现函数：** `academicConsensusExtractor(selectedPapers: any[])`

**重要性：** 防止 AI 胡写的核心 Prompt，后续所有写作都只能基于这里

### P5: CoWrite 输入整理 (CoWrite Input Formatter)

**作用：** 将学术共识要点整理为可供写作使用的结构化素材

**输入：** 学术共识要点数组
**输出：** JSON 格式的写作素材

```json
{
  "research_background": "人工智能在医学影像分析中逐步成为重要研究方向。",
  "technical_progress": [
    "深度学习模型用于自动特征提取与识别",
    "AI 系统在多类影像诊断任务中表现稳定"
  ],
  "open_challenges": [
    "模型可解释性不足",
    "临床落地受监管限制"
  ]
}
```

**输出结构：**
- `research_background`: 研究背景（字符串）
- `technical_progress`: 技术进展（数组）
- `open_challenges`: 开放挑战（数组）

**实现函数：** `cowriteInputFormatter(consensusPoints: string[])`

## 完整工作流函数

### `academicSearchWorkflow(userQueryZh: string)`

**功能：** 执行完整的 5 阶段学术搜索工作流

**返回值：**
```typescript
{
  keywords: {
    main_keywords: string[];
    related_keywords: string[];
  };
  searchIntent: {
    focus: string[];
  };
  papers: SearchResult[];
  consensusPoints: string[];
  cowriteInput: {
    research_background: string;
    technical_progress: string[];
    open_challenges: string[];
  };
}
```

**使用示例：**
```typescript
const result = await academicSearchWorkflow('人工智能在医学影像中的应用');
```

## 前端实现

### KnowledgeStage 组件更新

**新增功能：**

1. **智能搜索按钮**
   - 替换原有的"搜索"按钮
   - 提示用户输入中文研究需求

2. **搜索分析卡片**
   - 显示学术关键词（主关键词 + 相关关键词）
   - 显示研究关注重点
   - 显示学术共识要点
   - 显示写作素材（研究背景、技术进展、开放挑战）

3. **增强的搜索结果**
   - 显示论文标题、摘要、来源
   - 支持查看原文链接
   - 支持勾选需要的论文

**UI 改进：**
- 使用 Sparkles 图标表示 AI 功能
- 使用 Badge 组件展示关键词和标签
- 使用 Separator 分隔不同部分
- 使用列表展示要点和素材

## 技术细节

### JSON 解析容错

所有 Prompt 函数都包含双层 JSON 解析逻辑：

```typescript
try {
  return JSON.parse(result);
} catch (e) {
  const jsonMatch = result.match(/\{[\s\S]*\}/);
  if (jsonMatch) {
    return JSON.parse(jsonMatch[0]);
  }
  throw new Error('无法解析结果');
}
```

**容错策略：**
1. 首先尝试直接解析
2. 如果失败，使用正则表达式提取 JSON 部分
3. 如果仍然失败，抛出友好的错误提示

### OpenAlex 集成

**API 端点：**
```
https://api.openalex.org/works?search=${query}&per-page=10
```

**特点：**
- 完全免费的学术搜索 API
- 无需注册和密钥
- 数据质量高
- 适合学术和专业写作

**返回数据：**
```json
{
  "results": [
    {
      "title": "论文标题",
      "abstract": "摘要",
      "doi": "DOI",
      "publication_date": "发布日期",
      "primary_location": {
        "source": {
          "display_name": "期刊名称"
        }
      }
    }
  ]
}
```

## 优势

### 1. 多层质量保障

- **P1**: 确保搜索关键词的学术性
- **P2**: 明确搜索意图，避免偏离
- **P3**: 筛选高质量论文，去除噪声
- **P4**: 提取客观事实，防止胡写
- **P5**: 结构化整理，便于写作

### 2. 降低 AI 检测率

- 基于真实学术论文
- 提取客观事实而非生成内容
- 保持学术严谨性
- 避免 AI 套话

### 3. 提升写作质量

- 提供权威学术背景
- 明确技术进展
- 指出开放挑战
- 素材可追溯

### 4. 用户体验优化

- 输入中文即可
- 自动转换为学术关键词
- 一键获取高质量素材
- 可视化展示分析结果

## 使用流程

### 用户操作流程

1. **输入研究需求**
   - 在搜索框输入中文研究需求
   - 例如："人工智能在医学影像中的应用"

2. **点击智能搜索**
   - 系统自动执行 5 阶段工作流
   - 显示进度提示

3. **查看搜索分析**
   - 查看学术关键词
   - 了解研究关注重点
   - 阅读学术共识要点
   - 查看写作素材

4. **选择论文**
   - 勾选需要的论文
   - 可以查看原文链接

5. **确认选择**
   - 点击"确认选择"按钮
   - 进入下一阶段

### 系统处理流程

1. **接收中文需求**
   ```typescript
   const query = "人工智能在医学影像中的应用";
   ```

2. **P1: 转写为英文关键词**
   ```typescript
   const keywords = await academicSearchRewriting(query);
   // 输出: { main_keywords: ["artificial intelligence", "medical imaging"], ... }
   ```

3. **P2: 澄清搜索意图**
   ```typescript
   const searchIntent = await searchScopeClarifier(keywords.main_keywords);
   // 输出: { focus: ["方法与技术原理", "应用场景与实践"] }
   ```

4. **OpenAlex 搜索**
   ```typescript
   const searchResults = await callWebSearch(allKeywords.join(' '));
   // 返回 10 篇论文
   ```

5. **P3: 筛选 Top N 论文**
   ```typescript
   const selection = await topPaperSelector(query, searchResults);
   // 输出: { selected_indexes: [0, 2, 5] }
   ```

6. **P4: 提取学术共识**
   ```typescript
   const consensusPoints = await academicConsensusExtractor(selectedPapers);
   // 输出: ["要点1", "要点2", ...]
   ```

7. **P5: 整理写作素材**
   ```typescript
   const cowriteInput = await cowriteInputFormatter(consensusPoints);
   // 输出: { research_background: "...", technical_progress: [...], ... }
   ```

8. **保存到知识库**
   ```typescript
   for (const paper of selectedPapers) {
     await createKnowledgeBase({ ... });
   }
   ```

## 错误处理

### 常见错误及处理

1. **LLM API 配置未完成**
   ```
   错误提示: "系统 LLM 配置未完成，请联系管理员配置通义千问 API 密钥"
   解决方案: 管理员在管理面板配置 LLM API 密钥
   ```

2. **搜索无结果**
   ```typescript
   if (!searchResults || searchResults.length === 0) {
     return {
       keywords,
       searchIntent,
       papers: [],
       consensusPoints: [],
       cowriteInput: null,
     };
   }
   ```

3. **JSON 解析失败**
   ```
   错误提示: "无法解析学术关键词"
   解决方案: 使用正则表达式提取 JSON，或提示用户重试
   ```

4. **OpenAlex API 失败**
   ```
   错误提示: "搜索失败: 无法搜索信息"
   解决方案: 检查网络连接，或稍后重试
   ```

## 性能优化

### 1. 并行处理

某些步骤可以并行执行：

```typescript
// P1 和 P2 可以串行，但 P2 不是必须的
const keywords = await academicSearchRewriting(userQueryZh);
const [searchIntent, searchResults] = await Promise.all([
  searchScopeClarifier(allKeywords),
  callWebSearch(searchQuery)
]);
```

### 2. 缓存机制

可以缓存常见查询的结果：

```typescript
// 未来优化：添加缓存层
const cacheKey = `academic_search:${userQueryZh}`;
const cached = await getCache(cacheKey);
if (cached) return cached;
```

### 3. 流式输出

对于长时间的 LLM 调用，可以考虑流式输出：

```typescript
// 未来优化：支持流式输出
for await (const chunk of streamLLMGenerate(prompt)) {
  updateUI(chunk);
}
```

## 后续优化方向

### 1. 增强筛选逻辑

- 根据 P2 的搜索意图调整 P3 的筛选权重
- 例如：如果关注"研究趋势"，优先选择综述论文

### 2. 多轮对话

- 允许用户对搜索结果进行反馈
- 根据反馈调整关键词和筛选策略

### 3. 引用管理

- 自动生成引用格式
- 支持导出参考文献列表

### 4. 跨项目复用

- 将学术共识要点保存到全局知识库
- 支持跨项目搜索和复用

### 5. 可视化分析

- 显示关键词关系图
- 显示论文引用网络
- 显示研究趋势时间线

## 测试清单

- [x] P1: 中文需求转英文关键词
- [x] P2: 搜索意图澄清
- [x] P3: Top N 论文筛选
- [x] P4: 学术共识提取
- [x] P5: CoWrite 输入整理
- [x] 完整工作流函数
- [x] KnowledgeStage 组件更新
- [x] JSON 解析容错
- [x] 错误处理
- [x] UI 展示优化
- [x] 代码通过 lint 检查

## 完成状态

✅ 5 个 Prompt 全部实现
✅ 完整工作流函数实现
✅ 前端组件更新完成
✅ JSON 解析容错完成
✅ 错误处理完善
✅ UI 优化完成
✅ 代码通过 lint 检查
✅ 文档编写完成

🎉 **学术搜索工作流已完整实现！**

## 示例输出

### 输入
```
人工智能在医学影像中的应用
```

### P1 输出
```json
{
  "main_keywords": [
    "artificial intelligence",
    "medical imaging",
    "deep learning"
  ],
  "related_keywords": [
    "computer-aided diagnosis",
    "radiology AI",
    "image segmentation"
  ]
}
```

### P2 输出
```json
{
  "focus": [
    "方法与技术原理",
    "应用场景与实践"
  ]
}
```

### P3 输出
```json
{
  "selected_indexes": [0, 2, 5, 8]
}
```

### P4 输出
```json
[
  "深度学习方法被广泛用于医学影像特征提取",
  "AI 辅助诊断在多类影像任务中提升准确率",
  "高质量标注数据对模型性能具有显著影响",
  "临床应用仍受可解释性与监管要求限制"
]
```

### P5 输出
```json
{
  "research_background": "人工智能在医学影像分析中逐步成为重要研究方向。",
  "technical_progress": [
    "深度学习模型用于自动特征提取与识别",
    "AI 系统在多类影像诊断任务中表现稳定"
  ],
  "open_challenges": [
    "模型可解释性不足",
    "临床落地受监管限制"
  ]
}
```

## 技术栈

- **前端**: React + TypeScript
- **UI 组件**: shadcn/ui
- **LLM**: 通义千问 (Qwen) / OpenAI / Anthropic
- **搜索**: OpenAlex API
- **数据库**: Supabase
- **Edge Functions**: Deno

## 相关文件

- `/src/db/api.ts` - API 函数实现
- `/src/components/workflow/KnowledgeStage.tsx` - 前端组件
- `/supabase/functions/llm-generate/index.ts` - LLM Edge Function
- `/supabase/functions/web-search/index.ts` - 搜索 Edge Function
