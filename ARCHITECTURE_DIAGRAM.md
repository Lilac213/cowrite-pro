# 🏗️ 新版搜索系统架构图

## 整体流程

```
用户输入研究需求
        ↓
┌───────────────────────────────────────────────────────────┐
│  Research Retrieval Agent                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  1. 调用 Qwen API                                    │  │
│  │     输入: 研究需求文档                               │  │
│  │     输出: ---THOUGHT--- + ---JSON---                 │  │
│  └─────────────────────────────────────────────────────┘  │
│                         ↓                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  2. 提取 ---JSON--- 部分                             │  │
│  │     解析: academic_queries, news_queries, web_queries│  │
│  └─────────────────────────────────────────────────────┘  │
│                         ↓                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  3. 并行调用外部 API                                 │  │
│  │     ┌──────────────────┐                             │  │
│  │     │ Google Scholar   │ → 学术资料                  │  │
│  │     ├──────────────────┤                             │  │
│  │     │ TheNews          │ → 新闻动态                  │  │
│  │     ├──────────────────┤                             │  │
│  │     │ Smart Search     │ → 网络资源                  │  │
│  │     └──────────────────┘                             │  │
│  └─────────────────────────────────────────────────────┘  │
│                         ↓                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  4. 去重并返回结果                                   │  │
│  │     - academic_sources (最多10条)                    │  │
│  │     - news_sources (最多10条)                        │  │
│  │     - web_sources (最多10条)                         │  │
│  └─────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────┘
        ↓
┌───────────────────────────────────────────────────────────┐
│  Research Synthesis Agent                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  1. 调用 Qwen API                                    │  │
│  │     输入: 检索结果 + 原始需求                        │  │
│  │     输出: ---THOUGHT--- + ---JSON---                 │  │
│  └─────────────────────────────────────────────────────┘  │
│                         ↓                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  2. 提取 ---JSON--- 部分                             │  │
│  │     解析: synthesized_insights, key_data_points, ... │  │
│  └─────────────────────────────────────────────────────┘  │
│                         ↓                                  │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  3. 返回结构化的研究素材                             │  │
│  │     - 中文化处理                                     │  │
│  │     - 信息提炼                                       │  │
│  │     - 结构化归类                                     │  │
│  │     - 标注可引用性                                   │  │
│  └─────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────┘
        ↓
   可写作的研究素材
```

## ---THOUGHT--- / ---JSON--- 分离模式

### 旧版（不稳定）
```
┌─────────────────────────────────────────┐
│  LLM 输出                                │
│  ┌───────────────────────────────────┐  │
│  │ 我理解你的需求是...                │  │ ← 思考过程
│  │ {                                  │  │
│  │   "topic": "AI Agent",             │  │ ← JSON 开始
│  │   // 这是一个注释                  │  │ ← 注释（非法）
│  │   "key_points": [                  │  │
│  │     "商业化" "用户定位"            │  │ ← 缺少逗号
│  │   ],                               │  │
│  │ }                                  │  │ ← JSON 结束
│  │ 以上是我的分析                     │  │ ← 额外文本
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
        ↓
   ❌ JSON 解析失败
```

### 新版（稳定）
```
┌─────────────────────────────────────────┐
│  LLM 输出                                │
│  ┌───────────────────────────────────┐  │
│  │ ---THOUGHT---                      │  │
│  │ 我理解你的需求是...                │  │ ← 思考过程（自由表达）
│  │ 我会搜索以下关键词...              │  │
│  │ 预计能找到...                      │  │
│  │                                    │  │
│  │ ---JSON---                         │  │ ← 标记开始
│  │ {                                  │  │
│  │   "search_summary": {              │  │
│  │     "interpreted_topic": "...",    │  │
│  │     "key_dimensions": [...]        │  │
│  │   },                               │  │
│  │   "academic_queries": [...],       │  │
│  │   "news_queries": [...],           │  │
│  │   "web_queries": [...]             │  │
│  │ }                                  │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
        ↓
   提取 ---JSON--- 部分
        ↓
   ✅ JSON 解析成功
```

## 并行搜索架构

```
搜索计划
    ↓
┌───────────────────────────────────────────────────────┐
│  并行执行（Promise.all）                               │
│                                                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐│
│  │ Google       │  │ TheNews      │  │ Smart Search ││
│  │ Scholar      │  │              │  │ (Bing)       ││
│  │              │  │              │  │              ││
│  │ 查询1 → API  │  │ 查询1 → API  │  │ 查询1 → API  ││
│  │ 查询2 → API  │  │ 查询2 → API  │  │ 查询2 → API  ││
│  │              │  │              │  │              ││
│  │ ✅ 成功      │  │ ❌ 失败      │  │ ✅ 成功      ││
│  │ 返回5条      │  │ 返回0条      │  │ 返回5条      ││
│  └──────────────┘  └──────────────┘  └──────────────┘│
│         ↓                  ↓                  ↓        │
│         └──────────────────┴──────────────────┘        │
│                            ↓                           │
│                    合并 + 去重                         │
│                            ↓                           │
│              ✅ 返回10条结果（即使部分失败）            │
└───────────────────────────────────────────────────────┘
```

## 错误处理流程

```
API 调用
    ↓
┌─────────────────────────────────────────┐
│  try {                                   │
│    const response = await fetch(...)    │
│    const data = await response.json()   │
│    results.push(...data)                │
│  }                                       │
│  catch (error) {                         │
│    console.error('API 失败:', error)    │
│    // 不抛出错误，继续执行              │
│  }                                       │
└─────────────────────────────────────────┘
    ↓
继续执行其他 API
    ↓
返回所有成功的结果
```

## 数据流

```
用户输入
    ↓
研究需求文档 (JSON)
    ↓
┌─────────────────────────────────────────┐
│  Research Retrieval Agent                │
│  输入: requirementsDoc                   │
│  输出: {                                 │
│    search_summary: {...},                │
│    academic_sources: [...],              │
│    news_sources: [...],                  │
│    web_sources: [...],                   │
│    user_library_sources: []              │
│  }                                       │
└─────────────────────────────────────────┘
    ↓
检索结果
    ↓
┌─────────────────────────────────────────┐
│  Research Synthesis Agent                │
│  输入: retrievalResults + requirementsDoc│
│  输出: {                                 │
│    synthesized_insights: [...],          │
│    key_data_points: [...],               │
│    contradictions_or_gaps: [...]         │
│  }                                       │
└─────────────────────────────────────────┘
    ↓
可写作的研究素材
    ↓
用户使用
```

## 关键改进点

### 1. 格式稳定性
```
旧版: LLM 输出 → 直接解析 → ❌ 经常失败
新版: LLM 输出 → 提取 ---JSON--- → ✅ 几乎总是成功
```

### 2. 错误容忍
```
旧版: 任何错误 → 整个流程失败
新版: 单个 API 失败 → 其他 API 继续 → 返回部分结果
```

### 3. 调试能力
```
旧版: 错误信息模糊 → 难以定位问题
新版: raw_content + 详细日志 → 精确定位问题
```

## 性能指标

### 响应时间
```
LLM 调用: ~2-5秒
API 并行调用: ~1-3秒（取决于最慢的 API）
总时间: ~3-8秒
```

### 成功率
```
JSON 解析: ~100%（只要 LLM 输出包含 ---JSON--- 标记）
API 调用: ~90%（单个 API 失败不影响整体）
整体成功率: ~100%
```

### 数据质量
```
每个数据源: 最多10条
总计: 最多30条（去重后可能更少）
时效性: 2020年至今（学术）、近1-2年（新闻）、近12-24个月（网络）
```
