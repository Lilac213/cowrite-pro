# 文章生成内容传递到审校阶段修复文档

## 问题描述

用户反馈：在进入"内容审校"阶段时，左侧的文章内容区域为空，显示"无内容，请先生成文章内容"的错误提示。

## 问题原因

### 工作流程分析

**原有流程：**
1. 'drafting' 状态 → MaterialsStage（收集个人素材）
2. MaterialsStage 点击"确认并继续"或"跳过" → 直接更新状态为 'review_pass_1'
3. 'review_pass_1' 状态 → ReviewStage（期望草稿已存在）

**问题所在：**
- MaterialsStage 只是收集个人素材，但没有生成文章草稿
- 直接跳转到 ReviewStage 时，没有草稿内容可以加载
- ReviewStage 尝试加载草稿，但草稿不存在或为空

### 根本原因

工作流中缺少了"文章生成"这一关键步骤。MaterialsStage 应该在收集完个人素材后，立即调用 LLM 生成文章草稿，然后再进入审校阶段。

## 解决方案

### 1. MaterialsStage 集成文章生成功能

**新增功能：**
- 在 MaterialsStage 中集成文章生成逻辑
- 点击"确认并继续"或"跳过"时，自动生成文章草稿
- 生成完成后再更新项目状态为 'review_pass_1'

**实现代码：**

```typescript
const generateDraft = async () => {
  setGenerating(true);
  try {
    // 1. 获取所有必要数据
    const brief = await getBrief(projectId);
    const knowledge = await getKnowledgeBase(projectId);
    const outlines = await getOutlines(projectId);

    const selectedKnowledge = knowledge.filter((k) => k.selected);
    const selectedOutlines = outlines.filter((o) => o.selected);

    // 2. 构建 Prompt
    let prompt = `基于以下信息生成完整文章：

需求：${JSON.stringify(brief?.requirements || {})}

知识库：
${selectedKnowledge.map((k) => `- ${k.title}: ${k.content}`).join('\n')}

段落结构：
${selectedOutlines.map((o, i) => `${i + 1}. ${o.summary}`).join('\n')}`;

    // 3. 添加个人素材（如果有）
    if (experience || opinion || caseStudy) {
      prompt += `\n\n个人素材：`;
      if (experience) prompt += `\n亲身经历：${experience}`;
      if (opinion) prompt += `\n个人观点：${opinion}`;
      if (caseStudy) prompt += `\n案例故事：${caseStudy}`;
    }

    prompt += `\n\n请生成一篇完整的文章。`;

    // 4. 调用 LLM 生成文章
    const result = await callLLMGenerate(prompt);

    // 5. 保存草稿
    const existingDraft = await getLatestDraft(projectId);
    if (!existingDraft) {
      await createDraft({
        project_id: projectId,
        content: result,
        version: 1,
      });
    } else {
      await updateDraft(existingDraft.id, {
        content: result,
        version: existingDraft.version + 1,
      });
    }

    // 6. 更新项目状态
    await updateProject(projectId, { status: 'review_pass_1' });
    
    toast({
      title: '生成成功',
      description: '文章已生成，进入审校阶段',
    });
    
    onComplete();
  } catch (error: any) {
    toast({
      title: '生成失败',
      description: error.message || '无法生成文章',
      variant: 'destructive',
    });
  } finally {
    setGenerating(false);
  }
};
```

**按钮更新：**

```typescript
const handleSkip = async () => {
  await generateDraft();
};

const handleConfirm = async () => {
  await generateDraft();
};
```

**UI 更新：**

```tsx
<Button variant="outline" onClick={handleSkip} disabled={generating}>
  {generating ? (
    <>
      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
      生成中...
    </>
  ) : (
    '跳过'
  )}
</Button>
<Button onClick={handleConfirm} disabled={generating}>
  {generating ? (
    <>
      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
      生成中...
    </>
  ) : (
    '确认并继续'
  )}
</Button>
```

### 2. ReviewStage 增强错误处理

**新增功能：**
- 添加加载状态显示
- 添加空状态提示
- 改进错误提示信息

**实现代码：**

```typescript
const [loading, setLoading] = useState(true);

const loadDraft = async () => {
  setLoading(true);
  try {
    const data = await getLatestDraft(projectId);
    if (data) {
      setDraft(data);
      setCurrentContent(data.content || '');
      setOriginalContent(data.content || '');
    } else {
      toast({
        title: '未找到草稿',
        description: '请先在文章生成阶段生成内容',
        variant: 'destructive',
      });
    }
  } catch (error) {
    console.error('加载草稿失败:', error);
    toast({
      title: '加载失败',
      description: '无法加载文章内容',
      variant: 'destructive',
    });
  } finally {
    setLoading(false);
  }
};
```

**UI 更新：**

```tsx
{loading ? (
  <Card>
    <CardContent className="flex items-center justify-center min-h-[400px]">
      <div className="flex flex-col items-center gap-4">
        <Loader2 className="h-12 w-12 animate-spin text-primary" />
        <p className="text-muted-foreground">加载文章内容中...</p>
      </div>
    </CardContent>
  </Card>
) : !currentContent ? (
  <Card>
    <CardContent className="flex items-center justify-center min-h-[400px]">
      <div className="flex flex-col items-center gap-4 text-center">
        <div className="rounded-full bg-destructive/10 p-4">
          <Circle className="h-12 w-12 text-destructive" />
        </div>
        <div>
          <h3 className="text-lg font-semibold mb-2">无内容</h3>
          <p className="text-muted-foreground">请先生成文章内容</p>
        </div>
      </div>
    </CardContent>
  </Card>
) : (
  // 正常显示内容
)}
```

## 工作流程优化

### 优化后的流程

```
1. 明确需求 (BriefStage)
   ↓
2. 资料查询 (KnowledgeStage)
   ↓
3. 段落摘要 (OutlineStage)
   ↓
4. 文章生成 (MaterialsStage)
   - 收集个人素材（可选）
   - 调用 LLM 生成文章
   - 保存草稿
   - 更新状态为 'review_pass_1'
   ↓
5. 内容审校 (ReviewStage)
   - 加载草稿内容
   - 三遍审校流程
   - 更新状态为 'completed'
   ↓
6. 完成 (DraftStage readonly)
```

### 关键改进点

1. **MaterialsStage 职责扩展**
   - 原职责：收集个人素材
   - 新职责：收集个人素材 + 生成文章草稿

2. **数据流保证**
   - MaterialsStage 确保草稿已创建并保存
   - ReviewStage 可以安全地加载草稿内容

3. **用户体验优化**
   - 显示"生成中..."加载状态
   - 生成完成后自动跳转到审校阶段
   - 审校阶段显示加载状态和空状态

## 技术细节

### 草稿创建逻辑

```typescript
// 检查是否已存在草稿
const existingDraft = await getLatestDraft(projectId);

if (!existingDraft) {
  // 创建新草稿
  await createDraft({
    project_id: projectId,
    content: result,
    version: 1,
  });
} else {
  // 更新现有草稿
  await updateDraft(existingDraft.id, {
    content: result,
    version: existingDraft.version + 1,
  });
}
```

**优点：**
- 避免重复创建草稿
- 保留版本历史
- 支持重新生成

### 个人素材集成

```typescript
// 添加个人素材到 Prompt
if (experience || opinion || caseStudy) {
  prompt += `\n\n个人素材：`;
  if (experience) prompt += `\n亲身经历：${experience}`;
  if (opinion) prompt += `\n个人观点：${opinion}`;
  if (caseStudy) prompt += `\n案例故事：${caseStudy}`;
}
```

**特点：**
- 个人素材是可选的
- 只添加非空的素材
- 清晰标注素材类型

### 状态管理

```typescript
const [generating, setGenerating] = useState(false);

// 生成开始
setGenerating(true);

// 生成结束（成功或失败）
finally {
  setGenerating(false);
}
```

**用途：**
- 禁用按钮防止重复点击
- 显示加载状态
- 提供视觉反馈

## 测试场景

### 场景 1：正常流程

1. 用户完成段落摘要
2. 进入文章生成阶段（MaterialsStage）
3. 用户输入个人素材（可选）
4. 点击"确认并继续"
5. 系统显示"生成中..."
6. LLM 生成文章内容
7. 保存草稿到数据库
8. 更新项目状态为 'review_pass_1'
9. 自动跳转到审校阶段
10. ReviewStage 加载草稿内容
11. 左侧显示文章内容
12. 右侧显示三步审校流程

**预期结果：** ✅ 文章内容正常显示

### 场景 2：跳过个人素材

1. 用户完成段落摘要
2. 进入文章生成阶段（MaterialsStage）
3. 用户直接点击"跳过"
4. 系统显示"生成中..."
5. LLM 生成文章内容（不包含个人素材）
6. 保存草稿到数据库
7. 更新项目状态为 'review_pass_1'
8. 自动跳转到审校阶段
9. ReviewStage 加载草稿内容
10. 左侧显示文章内容

**预期结果：** ✅ 文章内容正常显示（不包含个人素材）

### 场景 3：生成失败

1. 用户点击"确认并继续"
2. 系统显示"生成中..."
3. LLM 调用失败（网络错误、API 错误等）
4. 显示错误提示："生成失败：无法生成文章"
5. 用户仍在 MaterialsStage
6. 可以重试

**预期结果：** ✅ 显示友好的错误提示，允许重试

### 场景 4：草稿已存在

1. 用户之前已生成过草稿
2. 用户返回 MaterialsStage 重新生成
3. 点击"确认并继续"
4. 系统检测到已存在草稿
5. 更新现有草稿（版本号 +1）
6. 跳转到审校阶段
7. 加载最新版本的草稿

**预期结果：** ✅ 使用最新生成的内容，不创建重复草稿

## 优势

### 1. 数据流完整性

- **保证草稿存在**：在进入审校阶段前，确保草稿已创建
- **避免空状态**：用户不会看到"无内容"的错误
- **版本管理**：支持重新生成，保留版本历史

### 2. 用户体验优化

- **无缝衔接**：从素材收集到文章生成一气呵成
- **加载反馈**：显示"生成中..."状态，用户知道系统在工作
- **错误处理**：生成失败时显示友好提示，允许重试

### 3. 代码结构优化

- **职责清晰**：MaterialsStage 负责生成，ReviewStage 负责审校
- **复用性强**：草稿创建逻辑可复用
- **易于维护**：逻辑集中，便于调试和优化

## 后续优化方向

### 1. 草稿预览

在 MaterialsStage 中添加"预览"按钮，允许用户在生成后预览文章内容，再决定是否进入审校阶段。

### 2. 增量生成

支持分段生成文章，先生成大纲，再逐段生成内容，提供更好的进度反馈。

### 3. 草稿历史

在 ReviewStage 中添加"查看历史版本"功能，允许用户查看和恢复之前的草稿版本。

### 4. 自动保存

在 MaterialsStage 中添加自动保存功能，用户输入个人素材时自动保存到数据库，避免数据丢失。

### 5. 生成进度

显示文章生成的详细进度（如：正在分析需求 → 正在检索知识库 → 正在生成内容），提供更好的用户体验。

## 完成状态

✅ MaterialsStage 集成文章生成功能
✅ 草稿创建和更新逻辑实现
✅ 个人素材集成到 Prompt
✅ 生成状态显示和按钮禁用
✅ ReviewStage 加载状态和空状态
✅ 错误处理和友好提示
✅ 工作流程优化
✅ 代码通过 lint 检查
✅ 文档编写完成

🎉 **文章生成内容传递到审校阶段已修复！**

## 相关文件

- `/src/components/workflow/MaterialsStage.tsx` - 文章生成阶段
- `/src/components/workflow/ReviewStage.tsx` - 审校阶段
- `/src/db/api.ts` - API 函数
- `/src/types/index.ts` - 类型定义
