# v138 æ›´æ–°è¯´æ˜ - ä¿®æ­£ LLM æœåŠ¡æä¾›å•†

## æ›´æ–°æ¦‚è¿°

ä¿®æ­£äº† v138 ä¸­çš„ LLM æœåŠ¡æä¾›å•†é…ç½®é”™è¯¯ï¼Œå°† Qwen æ¨¡å‹çš„è°ƒç”¨ä» SiliconFlow å¹³å°æ”¹ä¸ºé˜¿é‡Œäº‘ DashScope å¹³å°ã€‚

## é—®é¢˜è¯´æ˜

### é—®é¢˜ 1ï¼šé”™è¯¯çš„ API é…ç½®æç¤º

**ç°è±¡**ï¼šç®¡ç†é¢æ¿ä»ç„¶æç¤ºç”¨æˆ·é…ç½® SiliconFlow API Key

**åŸå› **ï¼š
- ç³»ç»Ÿå®é™…ä½¿ç”¨ Geminiï¼ˆå†…ç½®ï¼‰+ Qwenï¼ˆé˜¿é‡Œäº‘ DashScopeï¼‰
- ä½†ç®¡ç†é¢æ¿ä»æ˜¾ç¤º SiliconFlow é…ç½®ç•Œé¢
- ç”¨æˆ·å›°æƒ‘ï¼šä¸ºä»€ä¹ˆè¦é…ç½®ä¸€ä¸ªä¸ä½¿ç”¨çš„å¹³å°ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç§»é™¤ç®¡ç†é¢æ¿çš„ LLM API Key é…ç½®ç•Œé¢
- æ”¹ä¸ºæ˜¾ç¤º"LLM æœåŠ¡çŠ¶æ€"ä¿¡æ¯å¡ç‰‡
- è¯´æ˜åŒå±‚æ¶æ„å’Œå¯é€‰é…ç½®æ–¹å¼

### é—®é¢˜ 2ï¼šCORS é”™è¯¯

**ç°è±¡**ï¼š
```
Access to fetch at 'https://...research-synthesis-agent' has been blocked by CORS policy: 
Response to preflight request doesn't pass access control check: It does not have HTTP ok status.
```

**åŸå› **ï¼š
- Edge Function çš„ CORS é…ç½®æ­£ç¡®
- ä½†å¯èƒ½æ˜¯ç”±äº JWT è®¤è¯é—®é¢˜å¯¼è‡´ OPTIONS è¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- é‡æ–°éƒ¨ç½²æ‰€æœ‰ Edge Functions
- ç¡®ä¿ CORS headers æ­£ç¡®è®¾ç½®
- éªŒè¯ JWT è®¤è¯æµç¨‹

## æŠ€æœ¯å˜æ›´

### 1. æ›´æ–° Qwen API è°ƒç”¨

#### ä¹‹å‰ï¼ˆé”™è¯¯ï¼‰
```typescript
// ä½¿ç”¨ SiliconFlow API
const response = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`,
  },
  body: JSON.stringify({
    model: "Qwen/Qwen2.5-7B-Instruct",
    messages: options.messages,
    temperature: 0.7,
    max_tokens: 4096,
  }),
});
```

#### ç°åœ¨ï¼ˆæ­£ç¡®ï¼‰
```typescript
// ä½¿ç”¨é˜¿é‡Œäº‘ DashScope API
const response = await fetch("https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation", {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${apiKey}`,
  },
  body: JSON.stringify({
    model: "qwen-plus",
    input: {
      messages: options.messages,
    },
    parameters: {
      temperature: 0.7,
      max_tokens: 4096,
    },
  }),
});
```

### 2. æ›´æ–°ç¯å¢ƒå˜é‡åç§°

| ä¹‹å‰ï¼ˆé”™è¯¯ï¼‰ | ç°åœ¨ï¼ˆæ­£ç¡®ï¼‰ |
|-------------|-------------|
| `QIANWEN_API_KEY` | `DASHSCOPE_API_KEY` |

### 3. æ›´æ–°ç®¡ç†é¢æ¿ UI

#### ä¹‹å‰
```tsx
<Card>
  <CardHeader>
    <CardTitle>LLM é…ç½®</CardTitle>
    <CardDescription>é…ç½®å…¨å±€ LLM æœåŠ¡ï¼ˆé€šä¹‰åƒé—®ï¼‰</CardDescription>
  </CardHeader>
  <CardContent>
    <Label>API å¯†é’¥</Label>
    <Input
      type="password"
      placeholder="è¾“å…¥ SiliconFlow API å¯†é’¥"
      value={systemConfig.llm_api_key || ''}
      onChange={(e) => setSystemConfig({ ...systemConfig, llm_api_key: e.target.value })}
    />
    <p>åœ¨ SiliconFlow æ§åˆ¶å°è·å–ï¼šhttps://cloud.siliconflow.cn</p>
  </CardContent>
</Card>
```

#### ç°åœ¨
```tsx
<Card>
  <CardHeader>
    <CardTitle>LLM æœåŠ¡çŠ¶æ€</CardTitle>
    <CardDescription>ç³»ç»Ÿä½¿ç”¨åŒå±‚ LLM æ¶æ„ï¼Œæ— éœ€é…ç½®å³å¯ä½¿ç”¨</CardDescription>
  </CardHeader>
  <CardContent>
    <div className="p-4 bg-gradient-to-r from-blue-50 to-purple-50">
      <div>ğŸš€ åŒå±‚ LLM æ¶æ„</div>
      <div>ç¬¬ä¸€å±‚ï¼šGoogle Gemini 2.5 Flashï¼ˆç³»ç»Ÿå†…ç½®ï¼Œå…è´¹ä½¿ç”¨ï¼‰</div>
      <div>ç¬¬äºŒå±‚ï¼šé˜¿é‡Œäº‘é€šä¹‰åƒé—®ï¼ˆè‡ªåŠ¨å›é€€ï¼Œå¯é€‰é…ç½®ï¼‰</div>
    </div>
    <div className="p-3 bg-amber-50">
      <div>ğŸ’¡ å¯é€‰é…ç½®</div>
      <p>å¦‚éœ€é…ç½®é€šä¹‰åƒé—®ä½œä¸ºå¤‡ç”¨æ¨¡å‹ï¼Œè¯·è®¿é—®é˜¿é‡Œäº‘ DashScope æ§åˆ¶å°è·å– API Key</p>
    </div>
  </CardContent>
</Card>
```

## æ›´æ–°çš„æ–‡ä»¶

### Edge Functions
1. **research-synthesis-agent/index.ts**
   - æ›´æ–° `callQwen()` å‡½æ•°ä½¿ç”¨ DashScope API
   - æ›´æ–° `getQwenApiKey()` è¯»å– `DASHSCOPE_API_KEY`
   - æ›´æ–°é”™è¯¯æç¤ºä¿¡æ¯

2. **llm-generate/index.ts**
   - æ›´æ–° `callQwen()` å‡½æ•°ä½¿ç”¨ DashScope API
   - æ›´æ–° `getQwenApiKey()` è¯»å– `DASHSCOPE_API_KEY`
   - æ›´æ–°é”™è¯¯æç¤ºä¿¡æ¯

3. **summarize-content/index.ts**
   - æ›´æ–° `callQwen()` å‡½æ•°ä½¿ç”¨ DashScope API
   - æ›´æ–° `getQwenApiKey()` è¯»å– `DASHSCOPE_API_KEY`
   - æ›´æ–°é”™è¯¯æç¤ºä¿¡æ¯

### å‰ç«¯ä»£ç 
1. **src/pages/AdminPage.tsx**
   - ç§»é™¤ LLM API Key é…ç½®è¾“å…¥æ¡†
   - æ”¹ä¸ºæ˜¾ç¤º"LLM æœåŠ¡çŠ¶æ€"ä¿¡æ¯å¡ç‰‡
   - ä¿ç•™ SerpAPI é…ç½®ï¼ˆä»ç„¶éœ€è¦ï¼‰

### æ–‡æ¡£
1. **API_KEY_SETUP.md**
   - æ›´æ–°æ‰€æœ‰ SiliconFlow å¼•ç”¨ä¸º DashScope
   - æ›´æ–° API ç«¯ç‚¹å’Œè¯·æ±‚æ ¼å¼è¯´æ˜
   - æ›´æ–°é…ç½®æ­¥éª¤å’Œ FAQ

## éƒ¨ç½²çŠ¶æ€

### å·²é‡æ–°éƒ¨ç½²çš„ Edge Functions
- âœ… research-synthesis-agent (v138.1)
- âœ… llm-generate (v138.1)
- âœ… summarize-content (v138.1)

### å‰ç«¯ä»£ç 
- âœ… src/pages/AdminPage.tsx (å·²æ›´æ–°)
- âœ… Lint æ£€æŸ¥é€šè¿‡

## ç”¨æˆ·å½±å“

### å¯¹ç°æœ‰ç”¨æˆ·çš„å½±å“
1. **æ— éœ€ä»»ä½•æ“ä½œ**ï¼š
   - ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ Geminiï¼ˆå†…ç½®ï¼‰
   - å¤§å¤šæ•°ç”¨æˆ·ä¸å—å½±å“

2. **å·²é…ç½® SiliconFlow API Key çš„ç”¨æˆ·**ï¼š
   - æ—§çš„ API Key ä¸å†æœ‰æ•ˆ
   - å¦‚éœ€é…ç½®å¤‡ç”¨æ¨¡å‹ï¼Œéœ€è¦è·å– DashScope API Key
   - è”ç³»æŠ€æœ¯æ”¯æŒè¿›è¡Œé…ç½®

### å¯¹æ–°ç”¨æˆ·çš„å½±å“
1. **å¼€ç®±å³ç”¨**ï¼š
   - æ— éœ€é…ç½®ä»»ä½• API Key
   - Gemini æ¨¡å‹è‡ªåŠ¨å¯ç”¨

2. **å¯é€‰é…ç½®**ï¼š
   - å¦‚éœ€æ›´é«˜å¯ç”¨æ€§ï¼Œå¯é…ç½® DashScope API Key
   - é€šè¿‡æŠ€æœ¯æ”¯æŒå®Œæˆé…ç½®

## æµ‹è¯•å»ºè®®

### 1. æµ‹è¯• Gemini ä¸»è·¯å¾„
```bash
# 1. ç¡®ä¿æ²¡æœ‰é…ç½® DASHSCOPE_API_KEY
# 2. è¿›å…¥"çŸ¥è¯†ç ”ç©¶"é˜¶æ®µ
# 3. ç‚¹å‡»"èµ„æ–™æ•´ç†"æŒ‰é’®
# 4. æŸ¥çœ‹æ—¥å¿—ï¼Œåº”æ˜¾ç¤º"âœ“ Gemini è°ƒç”¨æˆåŠŸ"
```

### 2. æµ‹è¯• Qwen å›é€€è·¯å¾„ï¼ˆéœ€è¦é…ç½®ï¼‰
```bash
# 1. é…ç½® DASHSCOPE_API_KEY ç¯å¢ƒå˜é‡
supabase secrets set DASHSCOPE_API_KEY=sk-your-key-here

# 2. é‡æ–°éƒ¨ç½² Edge Functions
supabase functions deploy research-synthesis-agent

# 3. ä¸´æ—¶ç¦ç”¨ Geminiï¼ˆä¿®æ”¹ URL æµ‹è¯•ï¼‰
# 4. ç‚¹å‡»"èµ„æ–™æ•´ç†"æŒ‰é’®
# 5. æŸ¥çœ‹æ—¥å¿—ï¼Œåº”æ˜¾ç¤º"âœ“ Qwen è°ƒç”¨æˆåŠŸï¼ˆå›é€€ï¼‰"
```

### 3. æµ‹è¯•ç®¡ç†é¢æ¿
```bash
# 1. ä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•
# 2. è¿›å…¥ç®¡ç†é¢æ¿ â†’ ç³»ç»Ÿé…ç½®
# 3. æŸ¥çœ‹"LLM æœåŠ¡çŠ¶æ€"å¡ç‰‡
# 4. åº”æ˜¾ç¤ºåŒå±‚æ¶æ„è¯´æ˜
# 5. ä¸åº”æœ‰ API Key è¾“å…¥æ¡†
```

## API å¯¹æ¯”

### SiliconFlow APIï¼ˆæ—§ï¼‰
```bash
POST https://api.siliconflow.cn/v1/chat/completions
Authorization: Bearer sk-xxx

{
  "model": "Qwen/Qwen2.5-7B-Instruct",
  "messages": [...],
  "temperature": 0.7,
  "max_tokens": 4096
}

# å“åº”
{
  "choices": [
    {
      "message": {
        "content": "..."
      }
    }
  ]
}
```

### DashScope APIï¼ˆæ–°ï¼‰
```bash
POST https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
Authorization: Bearer sk-xxx

{
  "model": "qwen-plus",
  "input": {
    "messages": [...]
  },
  "parameters": {
    "temperature": 0.7,
    "max_tokens": 4096
  }
}

# å“åº”
{
  "output": {
    "text": "...",
    "choices": [
      {
        "message": {
          "content": "..."
        }
      }
    ]
  }
}
```

## é…ç½®è¿ç§»æŒ‡å—

### å¯¹äºå·²é…ç½® SiliconFlow çš„ç”¨æˆ·

1. **è·å– DashScope API Key**
   ```bash
   # è®¿é—®é˜¿é‡Œäº‘ DashScope æ§åˆ¶å°
   https://dashscope.console.aliyun.com/
   
   # æ³¨å†Œ/ç™»å½•é˜¿é‡Œäº‘è´¦å·
   # å¼€é€š DashScope æœåŠ¡
   # åˆ›å»º API Key
   ```

2. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   # é€šè¿‡ Supabase Dashboard
   Settings â†’ Edge Functions â†’ Secrets
   Name: DASHSCOPE_API_KEY
   Value: sk-your-dashscope-key
   
   # æˆ–é€šè¿‡ CLI
   supabase secrets set DASHSCOPE_API_KEY=sk-your-key
   ```

3. **é‡æ–°éƒ¨ç½²**
   ```bash
   supabase functions deploy research-synthesis-agent
   supabase functions deploy llm-generate
   supabase functions deploy summarize-content
   ```

4. **éªŒè¯**
   ```bash
   # æµ‹è¯•èµ„æ–™æ•´ç†åŠŸèƒ½
   # æŸ¥çœ‹ Edge Function æ—¥å¿—
   # ç¡®è®¤ Qwen å›é€€è·¯å¾„å¯ç”¨
   ```

## æ€»ç»“

è¿™æ¬¡æ›´æ–°ä¿®æ­£äº† v138 ä¸­çš„é…ç½®é”™è¯¯ï¼š

1. **æŠ€æœ¯å±‚é¢**ï¼š
   - âœ… Qwen æ¨¡å‹è°ƒç”¨æ”¹ä¸ºé˜¿é‡Œäº‘ DashScope
   - âœ… ç¯å¢ƒå˜é‡åç§°æ›´æ–°ä¸º `DASHSCOPE_API_KEY`
   - âœ… æ‰€æœ‰ Edge Functions å·²é‡æ–°éƒ¨ç½²

2. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - âœ… ç§»é™¤äº†è¯¯å¯¼æ€§çš„ SiliconFlow é…ç½®ç•Œé¢
   - âœ… æ¸…æ™°è¯´æ˜åŒå±‚æ¶æ„å’Œå¯é€‰é…ç½®
   - âœ… å¤§å¤šæ•°ç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œ

3. **æ–‡æ¡£æ›´æ–°**ï¼š
   - âœ… API_KEY_SETUP.md å®Œå…¨æ›´æ–°
   - âœ… æ‰€æœ‰ SiliconFlow å¼•ç”¨æ”¹ä¸º DashScope
   - âœ… é…ç½®æ­¥éª¤å’Œ FAQ æ›´æ–°

---

**æ›´æ–°æ—¶é—´**: 2025-02-10  
**ç‰ˆæœ¬**: v138.1  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éƒ¨ç½²
