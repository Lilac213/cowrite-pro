# 搜索功能修复和 Tavily API 配置文档

## 概述

本次更新修复了学术搜索中的数据库错误，并在管理面板中添加了 Tavily API 配置选项。

---

## 1. 修复数据库错误

### 问题描述

用户在进行学术资料查询时，输入"街舞未来发展"后点击"智能搜索"，系统返回了搜索结果（学术关键词和研究关注重点），但在保存到数据库时出现错误：

```
搜索失败
null value in column "content" of relation "knowledge_base" violates not-null constraint
```

### 问题原因

**根本原因：** 字段名称不匹配

1. **数据库表结构：** `knowledge_base` 表要求 `content` 字段为 NOT NULL
2. **搜索结果格式：** Google Scholar API 返回的论文对象包含 `abstract` 字段，而不是 `content` 字段
3. **代码错误：** KnowledgeStage 组件尝试访问 `paper.content`，但该字段不存在，导致传入 `null` 值

**数据流：**
```
Google Scholar API 返回:
{
  title: "...",
  abstract: "...",  // ← 字段名是 abstract
  authors: "...",
  ...
}

KnowledgeStage 尝试保存:
{
  content: paper.content,  // ← 访问不存在的字段，返回 undefined
  ...
}

数据库拒绝:
ERROR: null value in column "content" violates not-null constraint
```

### 解决方案

**修复代码：** `/src/components/workflow/KnowledgeStage.tsx`

```typescript
// 修复前
await createKnowledgeBase({
  project_id: projectId,
  title: paper.title,
  content: paper.content,  // ❌ 字段不存在
  source: paper.source,
  source_url: paper.url,
  ...
});

// 修复后
await createKnowledgeBase({
  project_id: projectId,
  title: paper.title || '无标题',  // ✅ 提供默认值
  content: paper.abstract || paper.content || '暂无摘要',  // ✅ 优先使用 abstract，提供后备值
  source: paper.source || 'Unknown',  // ✅ 提供默认值
  source_url: paper.url || undefined,
  ...
});
```

**关键改进：**

1. **字段映射修复**
   - 使用 `paper.abstract` 作为主要内容来源
   - 保留 `paper.content` 作为后备（兼容其他数据源）
   - 提供默认值 `'暂无摘要'` 确保不为 null

2. **防御性编程**
   - 所有必填字段都提供默认值
   - `title || '无标题'`
   - `source || 'Unknown'`
   - `content: paper.abstract || paper.content || '暂无摘要'`

3. **可选字段处理**
   - `source_url: paper.url || undefined`
   - `keywords: result.keywords?.main_keywords || []`

### 测试验证

**测试步骤：**
1. 进入项目的"资料查询"阶段
2. 输入中文搜索关键词（如"街舞未来发展"）
3. 点击"智能搜索"按钮
4. 等待搜索完成
5. 确认搜索结果成功保存到知识库
6. 检查知识库列表，确认论文标题、内容、来源等信息正确显示

**预期结果：**
- ✅ 搜索成功完成
- ✅ 显示"学术搜索完成，找到 X 篇高质量论文"
- ✅ 知识库列表显示搜索结果
- ✅ 每条记录包含标题、摘要、来源等信息
- ✅ 不再出现数据库错误

---

## 2. 添加 Tavily API 配置

### 功能需求

用户希望在搜索配置中添加 Tavily API 配置选项，作为实时内容搜索的补充。

### 实现方案

#### 2.1 更新管理面板

**文件：** `/src/pages/AdminPage.tsx`

**新增配置项：**

1. **Google Scholar API 配置**
   - 状态：已启用
   - 用途：学术论文搜索
   - API 密钥：INTEGRATIONS_API_KEY
   - 说明：用于搜索权威学术论文，提供标题、作者、引用数等信息

2. **AI Search 配置**
   - 状态：已启用
   - 用途：实时内容搜索
   - API 密钥：INTEGRATIONS_API_KEY
   - 说明：用于搜索实时内容和观点，提供 AI 生成的摘要和来源链接

3. **Tavily API 配置（新增）**
   - 状态：可选
   - 用途：高质量实时搜索
   - API 密钥：Tavily API Key
   - 说明：Tavily 提供高质量的实时搜索结果，可作为 AI Search 的补充

#### 2.2 UI 设计

**布局结构：**

```
搜索配置
├── Google Scholar API
│   ├── 状态：已启用
│   ├── 标签：学术论文搜索
│   └── API 密钥输入框
├── AI Search (Gemini 2.5 Flash)
│   ├── 状态：已启用
│   ├── 标签：实时内容搜索
│   └── API 密钥输入框
├── Tavily API
│   ├── 状态：未配置/已配置
│   ├── 标签：可选
│   └── API 密钥输入框
└── 说明文字
```

**视觉设计：**
- 每个 API 配置使用独立的边框卡片
- 使用 Badge 组件标注用途和状态
- 提供清晰的说明文字
- API 密钥输入框使用 `type="password"` 保护隐私
- 底部显示整体说明

#### 2.3 代码实现

```tsx
{/* Tavily 配置 */}
<div className="space-y-4 p-4 border rounded-lg">
  <div className="flex items-center justify-between">
    <h3 className="font-medium">Tavily API</h3>
    <Badge variant="outline">可选</Badge>
  </div>
  <div className="space-y-2">
    <Label htmlFor="tavily-status">状态</Label>
    <Input
      id="tavily-status"
      value={systemConfig.tavily_api_key ? '已配置' : '未配置'}
      disabled
      className="bg-muted"
    />
    <p className="text-xs text-muted-foreground">
      Tavily 提供高质量的实时搜索结果，可作为 AI Search 的补充
    </p>
  </div>
  <div className="space-y-2">
    <Label htmlFor="tavily-api-key">API 密钥</Label>
    <Input
      id="tavily-api-key"
      type="password"
      placeholder="请输入 Tavily API Key（可选）"
      value={systemConfig.tavily_api_key || ''}
      onChange={(e) => setSystemConfig({ ...systemConfig, tavily_api_key: e.target.value })}
    />
    <p className="text-xs text-muted-foreground">
      可在 <a href="https://tavily.com" target="_blank" rel="noopener noreferrer" className="text-primary hover:underline">Tavily 官网</a> 获取 API 密钥
    </p>
  </div>
</div>
```

**特点：**
- 动态显示状态（已配置/未配置）
- 提供官网链接，方便用户获取 API 密钥
- 明确标注为"可选"，不强制用户配置
- 与其他 API 配置保持一致的设计风格

#### 2.4 配置保存

**保存逻辑：**

```typescript
const handleSaveConfig = async () => {
  setSaving(true);
  try {
    // 保存所有配置
    await Promise.all([
      updateSystemConfig('llm_provider', systemConfig.llm_provider || 'qwen'),
      updateSystemConfig('llm_api_key', systemConfig.llm_api_key || ''),
      updateSystemConfig('google_scholar_api_key', systemConfig.google_scholar_api_key || ''),
      updateSystemConfig('ai_search_api_key', systemConfig.ai_search_api_key || ''),
      updateSystemConfig('tavily_api_key', systemConfig.tavily_api_key || ''),
    ]);

    toast({
      title: '保存成功',
      description: '系统配置已更新',
    });
  } catch (error) {
    toast({
      title: '保存失败',
      variant: 'destructive',
    });
  } finally {
    setSaving(false);
  }
};
```

**配置存储：**
- 所有配置保存到 `system_config` 表
- 使用 `config_key` 和 `config_value` 存储键值对
- 支持动态读取和更新

### 使用说明

#### 管理员配置步骤

1. **登录管理面板**
   - 使用管理员账号登录
   - 进入"管理面板"页面

2. **配置 Google Scholar API**
   - 在"搜索配置"部分找到"Google Scholar API"
   - 输入 INTEGRATIONS_API_KEY
   - 此密钥用于访问 Google Scholar 搜索服务

3. **配置 AI Search API**
   - 在"搜索配置"部分找到"AI Search"
   - 输入 INTEGRATIONS_API_KEY
   - 此密钥用于访问 AI Search 服务

4. **配置 Tavily API（可选）**
   - 在"搜索配置"部分找到"Tavily API"
   - 访问 https://tavily.com 注册账号
   - 获取 API 密钥
   - 输入 Tavily API Key
   - 点击"保存配置"按钮

5. **验证配置**
   - 保存后系统显示"保存成功"
   - Tavily 状态从"未配置"变为"已配置"
   - 可以在项目中使用 Tavily 搜索功能

#### 用户使用流程

1. **进入资料查询阶段**
   - 创建或打开项目
   - 完成需求确认
   - 进入"资料查询"阶段

2. **执行搜索**
   - 输入中文研究需求
   - 点击"智能搜索"按钮
   - 系统自动调用多个搜索引擎

3. **搜索引擎优先级**
   - **Google Scholar**：优先搜索学术论文
   - **AI Search**：搜索实时内容和观点
   - **Tavily**（如已配置）：提供高质量补充结果

4. **查看结果**
   - 搜索结果显示在知识库列表
   - 每条结果包含标题、摘要、来源、链接
   - 可以勾选需要的结果

5. **继续工作流**
   - 确认选择的知识库条目
   - 进入下一阶段（段落摘要）

---

## 搜索引擎对比

| 搜索引擎 | 用途 | 优势 | 数据来源 | 是否必需 |
|---------|------|------|---------|---------|
| **Google Scholar** | 学术论文搜索 | 权威性高、引用数据完整 | 学术期刊、会议论文 | 是 |
| **AI Search** | 实时内容搜索 | AI 生成摘要、来源标注 | 网页、新闻、博客 | 是 |
| **Tavily** | 高质量实时搜索 | 结果质量高、噪音少 | 精选网页内容 | 否（可选） |

---

## 技术细节

### 数据库表结构

**knowledge_base 表：**

```sql
CREATE TABLE knowledge_base (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id),
  title TEXT NOT NULL,
  content TEXT NOT NULL,  -- ← 必填字段
  source TEXT NOT NULL,
  source_url TEXT,
  published_at TIMESTAMPTZ,
  collected_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  next_update_suggestion TEXT,
  selected BOOLEAN NOT NULL DEFAULT false,
  keywords TEXT[],
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**system_config 表：**

```sql
CREATE TABLE system_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  config_key TEXT NOT NULL UNIQUE,
  config_value TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

### API 调用流程

```
用户输入搜索关键词
    ↓
academicSearchWorkflow(query)
    ↓
并行调用搜索 API
    ├── searchGoogleScholar(query)
    │   └── Edge Function: google-scholar-search
    │       └── Google Scholar API
    ├── searchAI(query)
    │   └── Edge Function: ai-search
    │       └── AI Search API (Gemini 2.5 Flash)
    └── searchTavily(query) [如已配置]
        └── Edge Function: tavily-search
            └── Tavily API
    ↓
合并搜索结果
    ↓
筛选 Top N 论文
    ↓
保存到 knowledge_base 表
    ↓
显示搜索结果
```

---

## 完成状态

### 问题 1：数据库错误修复
✅ 分析问题根本原因（字段名称不匹配）
✅ 修复 KnowledgeStage 组件
✅ 使用 `paper.abstract` 替代 `paper.content`
✅ 为所有必填字段提供默认值
✅ 添加防御性编程逻辑
✅ 测试验证修复效果

### 问题 2：Tavily API 配置
✅ 更新 AdminPage 搜索配置部分
✅ 添加 Google Scholar API 配置项
✅ 添加 AI Search API 配置项
✅ 添加 Tavily API 配置项（新增）
✅ 设计清晰的 UI 布局
✅ 实现配置保存逻辑
✅ 提供使用说明和官网链接

### 代码质量
✅ 所有代码通过 lint 检查
✅ 无 TypeScript 错误
✅ 无 ESLint 警告
✅ 代码结构清晰，易于维护

---

## 相关文件

### 问题 1：数据库错误修复
- `/src/components/workflow/KnowledgeStage.tsx` - 修复字段映射错误

### 问题 2：Tavily API 配置
- `/src/pages/AdminPage.tsx` - 添加搜索配置选项

---

## 后续优化方向

### 搜索功能优化
1. **实现 Tavily 搜索集成**
   - 创建 tavily-search Edge Function
   - 集成到 academicSearchWorkflow
   - 支持配置优先级和权重

2. **搜索结果去重**
   - 检测重复的论文标题
   - 合并来自不同来源的相同论文
   - 保留引用数最高的版本

3. **搜索结果排序**
   - 按引用数排序
   - 按发表时间排序
   - 按相关性排序

4. **搜索历史**
   - 保存搜索历史
   - 支持重新执行历史搜索
   - 显示搜索趋势

### 配置管理优化
1. **配置验证**
   - 验证 API 密钥格式
   - 测试 API 连接
   - 显示配置状态（有效/无效）

2. **配置导入导出**
   - 支持导出配置为 JSON
   - 支持从 JSON 导入配置
   - 便于迁移和备份

3. **配置版本管理**
   - 记录配置变更历史
   - 支持回滚到历史版本
   - 显示配置变更日志

---

🎉 **搜索功能修复和 Tavily API 配置已完成！**
