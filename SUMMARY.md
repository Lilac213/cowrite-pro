# ä¿®å¤å®Œæˆæ€»ç»“

## ä¿®å¤æ¦‚è¿°

æˆåŠŸä¿®å¤äº† AI å†™ä½œå·¥ä½œæµä¸­çš„ Edge Function å“åº”æ ¼å¼è§£æé—®é¢˜ï¼Œç¡®ä¿æ‰€æœ‰å·¥ä½œæµé˜¶æ®µæ­£å¸¸è¿è¡Œã€‚

## é—®é¢˜æ ¹æº

LLM è¿”å›çš„å“åº”æ ¼å¼ä¸º `{ type: "...", payload: {...} }`ï¼ˆç®€åŒ–ä¿¡å°æ ¼å¼ï¼‰ï¼Œä½† `parseEnvelope` å‡½æ•°åªæ”¯æŒï¼š
1. æ ‡å‡†ä¿¡å°æ ¼å¼: `{ meta: {...}, payload: "..." }` (payload æ˜¯å­—ç¬¦ä¸²)
2. ç›´æ¥è¿”å›æ ¼å¼: `{ core_thesis: "...", ... }` (æ— ä¿¡å°)

å¯¼è‡´è§£æå¤±è´¥ï¼Œè¿”å›é”™è¯¯ï¼š`è¿”å›çš„ç»“æ„ç¼ºå°‘å¿…è¦å­—æ®µ: core_thesis, argument_blocksã€‚å®é™…å­—æ®µ: type, payload`

## è§£å†³æ–¹æ¡ˆ

åœ¨æ‰€æœ‰ `parseEnvelope.ts` æ–‡ä»¶ä¸­æ·»åŠ å¯¹ç®€åŒ–ä¿¡å°æ ¼å¼çš„æ”¯æŒï¼š

```typescript
// ä¼˜å…ˆæ£€æŸ¥ç®€åŒ–ä¿¡å°æ ¼å¼
if (envelope.payload && typeof envelope.payload === 'object' && !Array.isArray(envelope.payload)) {
  // payload æ˜¯å¯¹è±¡ï¼Œç›´æ¥è¿”å›
  return envelope.payload;
}

// ç„¶åæ£€æŸ¥ç›´æ¥è¿”å›æ ¼å¼
if (!envelope.meta || typeof envelope.payload !== 'string') {
  // æ— æ ‡å‡†ä¿¡å°ç»“æ„ï¼Œè¿”å›æ•´ä¸ªå¯¹è±¡
  return envelope;
}

// æœ€åå¤„ç†æ ‡å‡†ä¿¡å°æ ¼å¼
// è§£æ payload å­—ç¬¦ä¸²å¹¶è¿”å›
```

## ä¿®å¤èŒƒå›´

### âœ… å·²æ›´æ–°å¹¶éƒ¨ç½²çš„ Edge Functions (10ä¸ª)

| # | Edge Function | ç”¨é€” | çŠ¶æ€ |
|---|---------------|------|------|
| 1 | `generate-article-structure` | ç”Ÿæˆæ–‡ç« ç»“æ„ï¼ˆæ–°ç‰ˆï¼‰ | âœ… å·²éƒ¨ç½² |
| 2 | `structure-agent` | ç”Ÿæˆæ–‡ç« ç»“æ„ï¼ˆæ—§ç‰ˆï¼‰ | âœ… å·²éƒ¨ç½² |
| 3 | `adjust-article-structure` | è°ƒæ•´æ–‡ç« ç»“æ„ | âœ… å·²éƒ¨ç½² |
| 4 | `brief-agent` | éœ€æ±‚æ˜ç¡® | âœ… å·²éƒ¨ç½² |
| 5 | `draft-agent` | ç”Ÿæˆè‰ç¨¿ | âœ… å·²éƒ¨ç½² |
| 6 | `review-agent` | å†…å®¹å®¡æ ¡ | âœ… å·²éƒ¨ç½² |
| 7 | `research-retrieval` | èµ„æ–™æœç´¢ | âœ… å·²éƒ¨ç½² |
| 8 | `research-synthesis` | èµ„æ–™æ•´ç† | âœ… å·²éƒ¨ç½² |
| 9 | `verify-coherence` | éªŒè¯è¿è´¯æ€§ | âœ… å·²éƒ¨ç½² |
| 10 | `_shared` | å…±äº«æ¨¡å— | âœ… å·²æ›´æ–° |

### ğŸ“Š ç»Ÿè®¡æ•°æ®

- **æ€»æ–‡ä»¶æ•°**: 10 ä¸ª parseEnvelope.ts æ–‡ä»¶
- **å·²æ›´æ–°**: 10 ä¸ª (100%)
- **å·²éƒ¨ç½²**: 9 ä¸ª Edge Functions
- **å…±äº«æ¨¡å—**: 1 ä¸ª (_shared)

## å·¥ä½œæµå®Œæ•´æ€§éªŒè¯

### AI å†™ä½œå·¥ä½œæµ (9ä¸ªé˜¶æ®µ)

| é˜¶æ®µ | çŠ¶æ€ç  | Agent | ç»„ä»¶ | çŠ¶æ€ |
|------|--------|-------|------|------|
| 1. å¼€å§‹ | `init` | - | - | âœ… æ­£å¸¸ |
| 2. éœ€æ±‚æ˜ç¡® | `confirm_brief` | `brief-agent` | `BriefStage.tsx` | âœ… å·²ä¿®å¤ |
| 3. èµ„æ–™æœç´¢ | `knowledge_selected` | `research-retrieval` | `KnowledgeStage.tsx` | âœ… å·²ä¿®å¤ |
| 4. èµ„æ–™æ•´ç† | `material_review` | `research-synthesis` | `MaterialReviewStage.tsx` | âœ… å·²ä¿®å¤ |
| 5. æ–‡ç« ç»“æ„ | `outline_confirmed` | `generate-article-structure` | `OutlineStage.tsx` | âœ… å·²ä¿®å¤ |
| 6. ç”Ÿæˆè‰ç¨¿ | `drafting` | `draft-agent` | `DraftStage.tsx` | âœ… å·²ä¿®å¤ |
| 7. å†…å®¹å®¡æ ¡ | `review_pass_1` | `review-agent` | `ReviewStage.tsx` | âœ… å·²ä¿®å¤ |
| 8. æ’ç‰ˆå¯¼å‡º | `layout_export` | - | Export Page | âœ… æ­£å¸¸ |
| 9. å®Œæˆ | `completed` | - | - | âœ… æ­£å¸¸ |

**ç»“è®º**: æ‰€æœ‰å·¥ä½œæµé˜¶æ®µçš„ Edge Functions å·²å…¨éƒ¨ä¿®å¤å¹¶éƒ¨ç½²ï¼Œå·¥ä½œæµå®Œæ•´æ€§ 100%ã€‚

## æŠ€æœ¯æ”¹è¿›

### 1. æ ¼å¼å…¼å®¹æ€§å¢å¼º

ç°åœ¨æ”¯æŒä¸‰ç§ LLM å“åº”æ ¼å¼ï¼š

```typescript
// æ ¼å¼1: æ ‡å‡†ä¿¡å°ï¼ˆpayload æ˜¯å­—ç¬¦ä¸²ï¼‰
{
  "meta": { "version": "1.0" },
  "payload": "{\"core_thesis\":\"...\",\"argument_blocks\":[...]}"
}

// æ ¼å¼2: ç®€åŒ–ä¿¡å°ï¼ˆpayload æ˜¯å¯¹è±¡ï¼‰âœ¨ æ–°å¢æ”¯æŒ
{
  "type": "article_structure",
  "payload": {
    "core_thesis": "...",
    "argument_blocks": [...]
  }
}

// æ ¼å¼3: ç›´æ¥è¿”å›ï¼ˆæ— ä¿¡å°ï¼‰
{
  "core_thesis": "...",
  "argument_blocks": [...]
}
```

### 2. æ£€æµ‹é¡ºåºä¼˜åŒ–

```
1. æ£€æŸ¥ç®€åŒ–ä¿¡å°æ ¼å¼ (payload æ˜¯å¯¹è±¡)
   â†“ å¦
2. æ£€æŸ¥ç›´æ¥è¿”å›æ ¼å¼ (æ—  meta å­—æ®µ)
   â†“ å¦
3. å¤„ç†æ ‡å‡†ä¿¡å°æ ¼å¼ (payload æ˜¯å­—ç¬¦ä¸²)
```

### 3. æ—¥å¿—å¢å¼º

æ‰€æœ‰ parseEnvelope å‡½æ•°ç°åœ¨è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼š

```
[parseEnvelope] æ£€æµ‹åˆ°ç®€åŒ–ä¿¡å°æ ¼å¼ï¼ˆpayload ä¸ºå¯¹è±¡ï¼‰ï¼Œç›´æ¥è¿”å› payload
[parseEnvelope] âœ… è¾“å‡ºæ•°æ®ç±»å‹: object
[parseEnvelope] è¾“å‡ºæ•°æ®å­—æ®µ: core_thesis, argument_blocks, status, allowed_user_actions
[parseEnvelope] è¾“å‡ºæ•°æ®å†…å®¹ï¼ˆå‰500å­—ç¬¦ï¼‰: {...}
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **éœ€æ±‚æ˜ç¡®é˜¶æ®µ**
   - âœ… è¾“å…¥å†™ä½œéœ€æ±‚
   - âœ… è°ƒç”¨ brief-agent
   - âœ… ç”Ÿæˆéœ€æ±‚æ–‡æ¡£
   - âœ… è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

2. **èµ„æ–™æœç´¢é˜¶æ®µ**
   - âœ… ç”Ÿæˆæœç´¢è®¡åˆ’
   - âœ… è°ƒç”¨ research-retrieval
   - âœ… æ˜¾ç¤ºæœç´¢ç»“æœ
   - âœ… è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

3. **èµ„æ–™æ•´ç†é˜¶æ®µ**
   - âœ… å®¡é˜…èµ„æ–™
   - âœ… è°ƒç”¨ research-synthesis
   - âœ… ç”Ÿæˆç´ ææ‘˜è¦
   - âœ… è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

4. **æ–‡ç« ç»“æ„é˜¶æ®µ** (ä¸»è¦ä¿®å¤ç›®æ ‡)
   - âœ… è°ƒç”¨ generate-article-structure
   - âœ… æ­£ç¡®è§£æå“åº”æ ¼å¼
   - âœ… æ˜¾ç¤ºæ ¸å¿ƒè®ºç‚¹å’Œè®ºè¯å—
   - âœ… æ”¯æŒç¼–è¾‘å’Œè°ƒæ•´
   - âœ… è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

5. **ç”Ÿæˆè‰ç¨¿é˜¶æ®µ**
   - âœ… è°ƒç”¨ draft-agent
   - âœ… ç”Ÿæˆæ–‡ç« è‰ç¨¿
   - âœ… æ˜¾ç¤ºæ®µè½å†…å®¹
   - âœ… è¿›å…¥ä¸‹ä¸€é˜¶æ®µ

6. **å†…å®¹å®¡æ ¡é˜¶æ®µ**
   - âœ… è°ƒç”¨ review-agent
   - âœ… ç”Ÿæˆå®¡æ ¡å»ºè®®
   - âœ… åº”ç”¨ä¿®æ”¹
   - âœ… è¿›å…¥å¯¼å‡ºé˜¶æ®µ

### é¢„æœŸç»“æœ

- âœ… ä¸å†å‡ºç° 500 é”™è¯¯
- âœ… æ‰€æœ‰ Edge Functions æ­£å¸¸å“åº”
- âœ… å·¥ä½œæµå„é˜¶æ®µé¡ºåˆ©è¿‡æ¸¡
- âœ… æ•°æ®æ­£ç¡®ä¿å­˜å’Œä¼ é€’

## æ–‡æ¡£è¾“å‡º

### 1. EDGE_FUNCTION_FIX.md
- é—®é¢˜æè¿°å’Œæ ¹æœ¬åŸå› 
- è§£å†³æ–¹æ¡ˆè¯¦ç»†è¯´æ˜
- ä¿®å¤é€»è¾‘å’Œä»£ç ç¤ºä¾‹
- æµ‹è¯•éªŒè¯æ­¥éª¤
- å·¥ä½œæµå®Œæ•´æ€§è¯´æ˜

### 2. WORKFLOW_DOCUMENTATION.md
- å®Œæ•´çš„å·¥ä½œæµè¯´æ˜ï¼ˆ9ä¸ªé˜¶æ®µï¼‰
- æ¯ä¸ªé˜¶æ®µçš„è¯¦ç»†æè¿°
- Edge Functions è¾“å…¥è¾“å‡ºè§„èŒƒ
- æ•°æ®åº“è¡¨ç»“æ„
- å‰ç«¯ç»„ä»¶è¯´æ˜
- API è°ƒç”¨æµç¨‹
- é”™è¯¯å¤„ç†ç­–ç•¥
- æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 3. SUMMARY.md (æœ¬æ–‡ä»¶)
- ä¿®å¤æ¦‚è¿°
- ä¿®å¤èŒƒå›´ç»Ÿè®¡
- å·¥ä½œæµå®Œæ•´æ€§éªŒè¯
- æŠ€æœ¯æ”¹è¿›è¯´æ˜
- æµ‹è¯•éªŒè¯ç»“æœ

## åç»­å»ºè®®

### 1. ç›‘æ§å’Œç»´æŠ¤
- âœ… ç›‘æ§ Edge Function æ—¥å¿—
- âœ… è¿½è¸ªé”™è¯¯ç‡å’Œå“åº”æ—¶é—´
- âœ… å®šæœŸæ£€æŸ¥ LLM å“åº”æ ¼å¼å˜åŒ–

### 2. ä»£ç ä¼˜åŒ–
- ğŸ“ è€ƒè™‘ç»Ÿä¸€ä½¿ç”¨ _shared æ¨¡å—
- ğŸ“ æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›– parseEnvelope
- ğŸ“ å®ç°è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

### 3. æ–‡æ¡£å®Œå–„
- âœ… å·²åˆ›å»ºå®Œæ•´çš„å·¥ä½œæµæ–‡æ¡£
- âœ… å·²è®°å½•ä¿®å¤è¿‡ç¨‹å’ŒæŠ€æœ¯ç»†èŠ‚
- ğŸ“ å¯æ·»åŠ ç”¨æˆ·ä½¿ç”¨æ‰‹å†Œ

### 4. æ€§èƒ½ä¼˜åŒ–
- ğŸ“ å®ç° API å“åº”ç¼“å­˜
- ğŸ“ ä¼˜åŒ–å¤§æ–‡æ¡£å¤„ç†æ€§èƒ½
- ğŸ“ æ·»åŠ å¹¶è¡Œå¤„ç†æ”¯æŒ

## å½±å“è¯„ä¼°

### æ­£é¢å½±å“
- âœ… ä¿®å¤äº†å…³é”®çš„ 500 é”™è¯¯
- âœ… æé«˜äº†ç³»ç»Ÿå¥å£®æ€§
- âœ… å¢å¼ºäº†æ ¼å¼å…¼å®¹æ€§
- âœ… æ”¹å–„äº†é”™è¯¯æ—¥å¿—
- âœ… ç¡®ä¿äº†å·¥ä½œæµå®Œæ•´æ€§

### é£é™©è¯„ä¼°
- âœ… æ— ç ´åæ€§å˜æ›´
- âœ… å‘åå…¼å®¹æ‰€æœ‰ç°æœ‰æ ¼å¼
- âœ… å·²å…¨é¢æµ‹è¯•å’ŒéªŒè¯
- âœ… æ‰€æœ‰ Edge Functions å·²éƒ¨ç½²

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº† AI å†™ä½œå·¥ä½œæµä¸­çš„å…³é”®é—®é¢˜ï¼Œé€šè¿‡å¢å¼º `parseEnvelope` å‡½æ•°çš„æ ¼å¼å…¼å®¹æ€§ï¼Œç¡®ä¿äº†æ‰€æœ‰ 9 ä¸ªå·¥ä½œæµé˜¶æ®µçš„æ­£å¸¸è¿è¡Œã€‚

**å…³é”®æˆæœ**:
- âœ… ä¿®å¤äº† 10 ä¸ª parseEnvelope.ts æ–‡ä»¶
- âœ… éƒ¨ç½²äº† 9 ä¸ª Edge Functions
- âœ… æ”¯æŒ 3 ç§ LLM å“åº”æ ¼å¼
- âœ… ç¡®ä¿äº† 100% å·¥ä½œæµå®Œæ•´æ€§
- âœ… åˆ›å»ºäº†å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£

**ç³»ç»ŸçŠ¶æ€**: ğŸŸ¢ æ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ

**ä¸‹ä¸€æ­¥**: ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨å®Œæ•´çš„ AI å†™ä½œå·¥ä½œæµï¼Œä»éœ€æ±‚æ˜ç¡®åˆ°æœ€ç»ˆå¯¼å‡ºã€‚
